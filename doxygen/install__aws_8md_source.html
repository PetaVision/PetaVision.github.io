<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>PetaVision: docs/doxygen/src/install_aws.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PetaVision
   &#160;<span id="projectnumber">Alpha</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('install__aws_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">docs/doxygen/src/install_aws.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# AWS Installation</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;Welcome to the cloud. Here&#39;s everything you need to know about how to get your favorite run on Amazon&#39;s AWS services.</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;[TOC]</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;# Introduction</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;Amazon AWS is a suite of tools to provide a virtual computing environment for end users. Here are the services we&#39;ll be using.</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;- EC2: Elastic Compute Cloud</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;   + Allows you to create a virtual instance that run on Amazon hardware.</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;- EBS: Elastic Block Store</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;   + The virtual hard drive that EC2 requires to do file I/O</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;- Snapshots</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;   + A snapshot of an EBS is essentially a copy of that hard drive.</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;- AMI: Amazon Machine Image</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;   + Snapshots can be converted to AMIs, which contain the operating system, tools, and in our case, the PetaVision toolbox.</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;- IAM: Identity and Access Management</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;   + Amazon&#39;s user account control that allows for user accounts for one AWS account.</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;- S3: Simple Storage Service</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;   + Long term shared storage. We don&#39;t have file io access to S3; everything must be downloaded/uploaded through https or AWS CLI. Databases and checkpoints will be stored here.</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;There exists a PetaVision AMI called &#39;PetaVision Public AMI&#39; that has everything set up for PetaVision on GPUs. Additionally, the following software is installed on the image:</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;- Octave</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;- Python</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;- ffmpeg</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;- emacs</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;# Overview</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;Here&#39;s a quick overview of how our instance is set up.</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;- GPU spot instance</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;- 10GB root EBS that contains the OS, PetaVision and all software.</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;- 50 - 100GB personal EBS that will store sandboxes and output files.</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;- S3 for storing databases and checkpoints.</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;Services that cost money:</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;- GPU Spot Instance: market price, usually between $.10 and $.15 per hour</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;- EBS usage: $.10 per GB per Month</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;- S3 usage: $.03 per GB per Month</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;- Internet to EBS/S3 transfer: Free</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;- EBS/S3 transfer to Internet: cents per GB</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;- S3 to EBS and EBS to S3 transfers in the same region: Free</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;We are currently using the Oregon region.</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;# First time initialization</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;This section explains how to get a new user set up on the aws account to do runs.</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;## Activate your account </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;To create an AWS account, go to [Amazon&#39;s AWS page](http://aws.amazon.com) and click on Products.</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;If you are in Kenyon Lab, contact an account administrator to create and set up your account. You should get a user name and a</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;temporary password starting up. Follow [these instructions](md_docs_doxygen_src_aws_pv_internal.html) for setting up a user in the PetaVision account.</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;## Create your ssh key pair</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;Each instance must have an ssh key for security. Here&#39;s how to generate your own.</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;Open a terminal and enter the following commands</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;   cd ~/.ssh #Create it if it doesn&#39;t exist</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;   ssh-keygen -t rsa</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;Follow the instructions on the screen. Note the filename in which you saved the key, ex: username_aws.</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;   </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;   ssh-add ~/.ssh/username_aws</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;   pbcopy &lt; ~/.ssh/username_aws.pub #Copies contents of username_aws.pub to your clipboard for macs</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;Go to the EC2 management page, and find the option Key Pairs under Network and Security in the left tab.</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;Click Import Key Pair and paste the public key contents in. Click import.</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;Note that you may have to run ssh-add again if you get a public key error. To solve this, add this line to your `~/.bashrc` or `~/.profile`, replacing your private key name with username_aws</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;   </div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;   ssh-add ~/.ssh/username_aws</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;# Starting an Instance</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;An AWS Instance allows the user to create a virtual environment to do runs. We do spot instances to save money, and already have the PetaVision capabilities to restart a run if it does die. For more information on spot instances, go to http://aws.amazon.com/ec2/purchasing-options/spot-instances/.</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;## Creating a Spot Instance</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;If you intend to create a MPI Cluster of Instances jump to the bottom section</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;- Go to the EC2 management page. Click Instances under Instances in the left tab.</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;- Step 1: Choose an Amazon Machine Image (AMI)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    - Click Launch Instance.  Click on Community AMIs in the left tab.</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    - Using the search bar, find the AMI labeled `PetaVision Public AMI`. Click Select.</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;- Step 2: Choose an Instance Type</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    -  Pick a GPU instance (g2.2xlarge). Click next.</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;- Step 3: Configure Instance Details</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    - If you are making only one instance, keep the number of instances at 1.  (Note that there are additional steps involved if you are launching an mpi cluster of instances on this screen under the MPI Clusters section)</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    - Check Request Spot Instances under Purchasing option</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    - Pricing for an hour of an AWS instance comes from the dynamic market price determined by how many available spot instances there are and the lowest bid that still gets an instance. For more information about spot instances, you can read more here:[EC2 Spot Instance Pricing Information](http://aws.amazon.com/ec2/purchasing-options/spot-instances/)</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    -  You will see three different regions (a, b, c). We recommend you pick the least expensive region in Subnet. Next, enter your Maximum Price you are willing to pay to keep your instance. We recommend approximately $0.15 - $0.20 above the current price to insulate you from typical fluctuations in price. Remember that even if your bid is higher than the current price you will only pay the current price not your maximum price. </div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    - NOTE: If you want to see how the price typically fluctuates, you&#39;ll need to leave your current configuration or open a new tab, navigate back to EC2 &gt; Instances &gt; Spot Requests &gt; Pricing History. Select your instance type (eg. g2.2xlarge) and review the history.</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    - Note the subnet since any EBS volume you attach has to be in the same subnet region</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    - All of the remaining default values can be kept the same</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    - Click next.</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;- Step 4: Add Storage</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    -  No additional storage is required. Make sure Delete on Termination is checked. Click next.</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;- Step 5: Tag Instance</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    - Give your instance a name in the Value text box next to the Key name.</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    - Click next.</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    - (Note that there are additional steps involved if you are launching an mpi cluster of instances on this screen under the MPI Clusters section)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;- Step 6: Configure Security Group</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    - Check *Select an existing security group*.</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    - Select the default security group. Click Review and Launch.</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;- Step 7: Review Spot Instance Request</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    - After reviewing, click launch.</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    - Select Choose an existing key pair, and select your key pair that you created earlier.</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    - Check the acknowledgement, and click Request Spot Instance.</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;Spot instances will take a few minutes to fulfill. Looking under Instances in the left tab, you can see the status of your request.</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;If you did not name your instance on Step 5, name the instance something relevant once the instance is started.</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;The PetaVision Public AMI already includes all the code and tools you will need to start a PetaVision run.</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;# Working with a running instance</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;Now that you have an instance up, let&#39;s connect to it!</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;## SSH into your running instance</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;To start working with your instance, you need to know the IP address of your instance:</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;+ Go to the EC2 management page. Click Instances under Instances in the left tab.</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;+ Find your instance in the list and note the Public IP address of the instance.</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;+ To connect use the following command:</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;   </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;   ssh ec2-user@public_ip_address</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;+ NOTE: ec2-user is NOT a placeholder for you user name. </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;## Copy data to your instance</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;To start running experiments, you&#39;ll probably want some data to work with.</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;If you have a dataset on your local machine you can use the following command in a new terminal window:</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;   scp sourceFile ec2-user@public_ip_address:\~/destinationFile</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;Datasets hosted online can also be grabbed using wget. For example, the following command will download the CIFAR dataset:</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;   </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;   wget &quot;http://www.cs.toronto.edu/~kriz/cifar-10-matlab.tar.gz&quot;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;## Creating an EBS persistent volume</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;AWS Spot Instances can die at any time. We will need an EBS persistent volume to store any run output we have as well as any sandboxes being ran from.</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;### Create your volume</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;- Go to the EC2 management page. On the left, click Volumes under Elastic Block Store. Click Create Volume.</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;- Adjust the size of the volume. 50 to 100 GB should be more than enough, depending on your run.</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;- Select the same subnet availability zone as your running instance.</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;- Click create.</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;- It will take a few minutes to create the volume. Name it something appropriate.</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;### Mounting your new volume to a running instance</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;In order to use this volume in a running instance, we must mount it to a running instance.</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;- Go to the EC2 management page. On the left, click Volumes under Elastic Block Store.</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;- Select the volume you want to attach. The state of the volume should say available.</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;- Click actions, and select attach volume.</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;- Click on the Instance box and select your running instance.</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;- Make sure the device is set to `/dev/sdf`. This is the default value.</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;A new EBS volume is completely blank. That means we need to format the volume to our instance filesystem. Note that this needs to be done only once per new volume.</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;- Connect to your running instance.</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;   </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;   sudo mkfs -t ext4 /dev/sdf</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;## Setting up PetaVision</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;Because the instance was booted from a PetaVision AMI, all of PetaVision should already exist in the home directory. There are several things needed to be done for PetaVision setup. </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;If you want to download a new copy of PetaVision because you are a developer:</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        svn co https://sourceForgeUserName@svn.code.sf.net/p/petavision/code/trunk PetaVision</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        svn co https://sourceForgeUserNamesvn.code.sf.net/p/petavision/code/PVSystemTests PVSystemTests    (this is a standard sandbox useful for checking PetaVision)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;### Accessing your mounted volume in a running instance</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;- Connect to your running instance</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;- Run the file `~/startup.sh`</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;   + This will do 2 things: mount your data to the directory `~/mountData` and update PetaVision and PVSystemTests.</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;   + Make sure you followed the steps for attaching and formatting a drive listed above, otherwise your EBS volume will not attach correctly</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;### Setting up your sandbox in your persistent volume</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;- cd to mountData.</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;- Check out any sandboxes that you are planning on using. Ex:</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        svn co http://svn.code.sf.net/p/petavision/code/sandbox/HyPerHLCA HyPerHLCA            (this is read only)</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;- cd to ~/workspace.</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;- Edit CMakeLists.txt using your favorite command-line text editor. (eg. vim or emacs)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;- At the end of the file, add the absolute path to your sandbox to the cmakelists. Ex:</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;   </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        add_subdirectory(/home/ec2-user/mountData/HyPerHLCA /home/ec2-user/mountData/HyPerHLCA)</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;Note that the same directory is put twice into the command add_subdirectory.</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;### Building PetaVision</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;   cd ~/workspace.</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;   ccmake . </div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;Most of these variables should already be set up, but here are the important ones:</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;- CMAKE_BUILD_TYPE: Release</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;- CUDA_GPU: True</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;- CUDA_RELEASE: True</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;- CUDNN: True</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;- CUDNN_PATH: /home/ec2-user/cuDNN/cudnn-6.5-linux-x64-R2-rc1u</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;- Open_MP_THREADS: True</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;Press c to configure. Press e to exit the print statements.</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;Repeat until the g option appears and press g. </div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;cd to your sandbox and run `make -j 8`</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;# Optional Configuration Details </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;You&#39;ve reached the end of the main installation instructions. If you want to store you data on an S3 server or set up MPI-linked instances, follow the instructions below. </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;## S3</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;S3 is long term storage for amazon&#39;s cloud. S3 objects (files, images) can only be accessed through http, but is much cheaper than ebs volumes. For the most part, you can skip this step to get started, but you can save a lot of money if you keep your datasets and results on S3</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;### Create your access key ############</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;- Go to the Identity &amp; Access Management page from the main AWS dashboard. On the left, click users.</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;- Select your account and click user actions.</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;- Select Manage Access Keys.</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;- Click create access key. Click Download Credentials and open the file. You will need the access key and secret access key.</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;### Create your bucket ##################</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;- Go to the S3 management page.</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;- See if your database is already there (such as kitti or neovision2heli datasets). If they are, you are done.</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;- On the top, click Create Bucket.</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;- Name your bucket something appropriate.</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;- Make sure your region is the same as your ec2 users. Transferring from region to region costs money.</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;- Click create.</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;### S3 Setup ##################</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;- SSH into your running instance.</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;- Enter the following command:</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;   aws configure</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;- Enter your access key and secret access key. The rest can be left blank.</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;## S3 Transfer</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;There are several ways to upload data to S3 to an existing bucket.</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;### EBS Volume to S3 (preferred) #######################</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;- Getting your database on S3:</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;- Download your database, most likely to mountData. Make sure your EBS volume is big enough to store all of the database.</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;- cd to the outer directory of your database.</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;   </div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;   aws s3 cp --recursive myDatabaseFolder s3://yourBin/myDatabaseFolder</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;- Note that you must put myDatabaseFolder on both the destination and source to keep the directory structure on s3.</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;- Optional: Make sure you have all of your database on s3. Run the same command as above except for sync instead of cp.</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;- Once the data is on s3, you can delete the local data off the EBS volume.</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;### Local to S3 ###########################</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;- Go to the S3 management page.</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;- Click an existing bucket that you would like your dataset to be, or create one and enter the bucket.</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;- Click upload.</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;- Drag the folder you would like to upload to the window.</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;- Click start upload.</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;Once you have your data on S3, you can specify a list of urls to feed to PetaVision Movie layer.</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;As an example:</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;   </div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;   s3://myBin/myDatabaseFolder/img00.png</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;   s3://myBin/myDatabaseFolder/img01.png</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;   s3://myBin/myDatabaseFolder/img02.png</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;### PetaVision Parameter Changes</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;Here are the changes you need to make to your parameter file.</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;- In your movie layers, make sure your list of filenames is a list of s3 urls.</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;- Change your output directory to somewhere in mountData.</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;- Future work will be done to get checkpoints on s3.</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;## MPI Clusters</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;This section explains how to set up a cluster of instances to do a PetaVision run across multiple instances. Most of the instructions are the same, with several difference when launching instances:</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;### Configure Instance Details screen #########</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;- Set number of instances to the number of instances you would like to use in the cluster.</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;- Under Placement Group, create or select a placement group. All instance under one placement group have extra bandwidth between the nodes.</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;   + Note: If you chose an existing placement group, it must be in the same availability zone that you are requesting for the instance (e.g., &quot;us-west-2a&quot;). </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;### Configure Security Group screen #############</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;When selecting an existing security group, use MPI_security instead of the default security group. This allows each instance to accept inbound data from other instances using this security group ID.</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;### Specific MPI cluster setup #############</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;- On your local machine, navigate to `petavision_trunk/docs/AWS/`</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;- Edit the file `hosts`</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;- Leave the first line alone. Add the external ip address for every node in your cluster. node0 will be your root node, the instance you will be launching everything from.</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;- Edit the file nodefile. Add each additional node you added to hosts, with the number of mpi processes you would like to run on as `slots`</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;- Run setup.sh in this directory on your local machine. This will move all the nessessary ssh keys to the clusters, as well as adding every node in the cluster into hosts.</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;   + This script will update and build PetaVision.</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;- ssh into your root node (node0).</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;- Follow the instructions to mount your EBS drive to your root node. Note that only the root node does any file io, so the root node is the only node that you need to attach and mount your volume to.</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;- Build your sandbox executable on the root node. Copy and move your sandbox executable somewhere *NOT* in your attached EBS volume (for example, in your home directory).</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;- Copy your executable to all nodes to your cluster. To do this, run the following from your home directory:</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;   sh cpCluster.sh path_to_executable</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;To run from your root node, use the following command:</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;   mpirun -np num_processors -hostfile ~/nodefile --bind-to none path_to_executable petavision_parameters</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;The `--bind-to none` flag is nessessary to get full threading utilization on aws.</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>install_aws.md</b></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
