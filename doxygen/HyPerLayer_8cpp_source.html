<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>PetaVision: OpenPV/src/layers/HyPerLayer.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PetaVision
   &#160;<span id="projectnumber">Alpha</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('HyPerLayer_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">HyPerLayer.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * HyPerLayer.cpp</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *  Created on: Jul 29, 2008</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *  The top of the hierarchy for layer classes.</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *  To make it easy to subclass from classes in the HyPerLayer hierarchy,</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *  please follow the guidelines below when adding subclasses to the HyPerLayer hierarchy:</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *  For a class named DerivedLayer that is derived from a class named BaseLayer,</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *  the .hpp file should have</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;HyPerLayer.hpp&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;checkpointing/CheckpointEntryPvpBuffer.hpp&quot;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;checkpointing/CheckpointEntryRandState.hpp&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;columns/HyPerCol.hpp&quot;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;connections/BaseConnection.hpp&quot;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;include/default_params.h&quot;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;include/pv_common.h&quot;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;io/FileStream.hpp&quot;</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;io/io.hpp&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacePV.html">PV</a> {</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// This constructor is protected so that only derived classes can call it.</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">// It should be called as the normal method of object construction by</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">// derived classes.  It should NOT call any virtual methods</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;HyPerLayer::HyPerLayer() { initialize_base(); }</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;HyPerLayer::HyPerLayer(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, HyPerCol *hc) {</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;   initialize_base();</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a4427fa8d7ed110c3cc45d243a425c16f">initialize</a>(name, hc);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;}</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">// initialize_base should be called only by constructors.  It should not</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">// call any virtual methods, because polymorphism is not available when</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">// a base class constructor is inherited from a derived class constructor.</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">// In general, initialize_base should be used only to initialize member variables</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">// to safe values.</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keywordtype">int</span> HyPerLayer::initialize_base() {</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;   name                         = NULL;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;   probes                       = NULL;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;   nxScale                      = 1.0f;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;   nyScale                      = 1.0f;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;   numFeatures                  = 1;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;   mirrorBCflag                 = 0;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;   xmargin                      = 0;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;   ymargin                      = 0;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;   numProbes                    = 0;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;   numChannels                  = 2;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;   clayer                       = NULL;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;   GSyn                         = NULL;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;   marginIndices                = NULL;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;   numMargin                    = 0;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;   writeTime                    = 0;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;   initialWriteTime             = 0;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;   triggerFlag                  = <span class="keyword">false</span>; <span class="comment">// Default to update every timestamp</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;   triggerLayer                 = NULL;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;   triggerLayerName             = NULL;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;   triggerBehavior              = NULL;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;   triggerBehaviorType          = NO_TRIGGER;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;   triggerResetLayerName        = NULL;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;   triggerOffset                = 0;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;   initializeFromCheckpointFlag = <span class="keyword">false</span>;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;   mLastUpdateTime  = 0.0;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;   mLastTriggerTime = 0.0;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;   phase = 0;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;   numSynchronizedMarginWidthLayers = 0;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;   synchronizedMarginWidthLayers    = NULL;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;   dataType       = PV_FLOAT;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;   dataTypeString = NULL;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;   allocDeviceV             = <span class="keyword">false</span>;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;   allocDeviceGSyn          = <span class="keyword">false</span>;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;   allocDeviceActivity      = <span class="keyword">false</span>;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;   allocDeviceDatastore     = <span class="keyword">false</span>;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;   allocDeviceActiveIndices = <span class="keyword">false</span>;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;   d_V                      = NULL;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;   d_GSyn                   = NULL;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;   d_Activity               = NULL;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;   d_Datastore              = NULL;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;   d_ActiveIndices          = NULL;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;   d_numActive              = NULL;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;   updatedDeviceActivity    = <span class="keyword">true</span>; <span class="comment">// Start off always updating activity</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;   updatedDeviceDatastore   = <span class="keyword">true</span>;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;   updatedDeviceGSyn        = <span class="keyword">true</span>;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;   mRecvGpu                 = <span class="keyword">false</span>;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;   mUpdateGpu               = <span class="keyword">false</span>;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;   krUpdate                 = NULL;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDNN</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;   cudnn_GSyn      = NULL;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;   cudnn_Datastore = NULL;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDNN</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;   update_timer    = NULL;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;   recvsyn_timer   = NULL;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;   publish_timer   = NULL;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;   timescale_timer = NULL;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;   io_timer        = NULL;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;   gpu_recvsyn_timer = NULL;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;   gpu_update_timer  = NULL;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;   thread_gSyn = NULL;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;   recvConns.clear();</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;}</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00129"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a4427fa8d7ed110c3cc45d243a425c16f">  129</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classPV_1_1HyPerLayer.html#a4427fa8d7ed110c3cc45d243a425c16f">HyPerLayer::initialize</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="classPV_1_1HyPerCol.html">HyPerCol</a> *hc) {</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;   <span class="keywordtype">int</span> status = BaseLayer::initialize(name, hc);</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;   <span class="keywordflow">if</span> (status != PV_SUCCESS) {</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;   }</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;   <a class="code" href="classPV_1_1BaseObject.html#aa231f0cd917d5d96d4c94e7d676621f3">readParams</a>();</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;   writeTime                = initialWriteTime;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;   writeActivityCalls       = 0;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;   writeActivitySparseCalls = 0;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;   numDelayLevels = 1; <span class="comment">// If a connection has positive delay so that more delay levels are needed,</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;   <span class="comment">// numDelayLevels is increased when BaseConnection::communicateInitInfo calls</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;   <span class="comment">// increaseDelayLevels</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;   initClayer();</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;   mLastUpdateTime  = parent-&gt;getDeltaTime();</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;   mLastTriggerTime = parent-&gt;getDeltaTime();</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;}</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="keywordtype">int</span> HyPerLayer::initClayer() {</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;   clayer     = (<a class="code" href="structPVLayer__.html">PVLayer</a> *)calloc(1UL, <span class="keyword">sizeof</span>(<a class="code" href="structPVLayer__.html">PVLayer</a>));</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;   <span class="keywordtype">int</span> status = PV_SUCCESS;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;   <span class="keywordflow">if</span> (clayer == NULL) {</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      Fatal().printf(</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <span class="stringliteral">&quot;HyPerLayer \&quot;%s\&quot; error in rank %d process: unable to allocate memory for Clayer.\n&quot;</span>,</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            name,</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            parent-&gt;columnId());</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;   }</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;   <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> *loc = &amp;clayer-&gt;loc;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;   setLayerLoc(loc, nxScale, nyScale, numFeatures, parent-&gt;getNBatch());</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;   assert(loc-&gt;halo.lt == 0 &amp;&amp; loc-&gt;halo.rt == 0 &amp;&amp; loc-&gt;halo.dn == 0 &amp;&amp; loc-&gt;halo.up == 0);</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;   <span class="keywordtype">int</span> nBatch = parent-&gt;getNBatch();</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;   clayer-&gt;numNeurons  = loc-&gt;nx * loc-&gt;ny * loc-&gt;nf;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;   clayer-&gt;numExtended = clayer-&gt;numNeurons; <span class="comment">// initially, margin is zero; it will be updated as</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;   <span class="comment">// needed during the communicateInitInfo stage.</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;   clayer-&gt;numNeuronsAllBatches  = nBatch * loc-&gt;nx * loc-&gt;ny * loc-&gt;nf;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;   clayer-&gt;numExtendedAllBatches = clayer-&gt;numNeuronsAllBatches;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;   <span class="keywordtype">double</span> xScaled = -log2((<span class="keywordtype">double</span>)nxScale);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;   <span class="keywordtype">double</span> yScaled = -log2((<span class="keywordtype">double</span>)nyScale);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;   <span class="keywordtype">int</span> xScale = (int)nearbyint(xScaled);</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;   <span class="keywordtype">int</span> yScale = (int)nearbyint(yScaled);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;   clayer-&gt;xScale = xScale;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;   clayer-&gt;yScale = yScale;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;   <span class="comment">// Other fields of clayer will be set in allocateClayerBuffers, or during updateState</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;}</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;HyPerLayer::~HyPerLayer() {</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;   <span class="keyword">delete</span> recvsyn_timer;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;   <span class="keyword">delete</span> update_timer;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;   <span class="keyword">delete</span> publish_timer;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;   <span class="keyword">delete</span> timescale_timer;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;   <span class="keyword">delete</span> io_timer;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;   <span class="keyword">delete</span> gpu_recvsyn_timer;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;   <span class="keyword">delete</span> gpu_update_timer;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;   <span class="keyword">delete</span> mOutputStateStream;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;   <span class="keyword">delete</span> mInitVObject;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;   freeClayer();</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;   freeChannels();</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;   <span class="keywordflow">if</span> (krUpdate) {</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      <span class="keyword">delete</span> krUpdate;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;   }</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;   <span class="keywordflow">if</span> (d_V) {</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      <span class="keyword">delete</span> d_V;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;   }</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;   <span class="keywordflow">if</span> (d_Activity) {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      <span class="keyword">delete</span> d_Activity;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;   }</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;   <span class="keywordflow">if</span> (d_Datastore) {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      <span class="keyword">delete</span> d_Datastore;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;   }</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDNN</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;   <span class="keywordflow">if</span> (cudnn_Datastore) {</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      <span class="keyword">delete</span> cudnn_Datastore;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;   }</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDNN</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;   free(marginIndices);</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;   free(probes); <span class="comment">// All probes are deleted by the HyPerCol, so probes[i] doesn&#39;t need to be deleted,</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;   <span class="comment">// only the array itself.</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;   free(synchronizedMarginWidthLayers);</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;   free(triggerLayerName);</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;   free(triggerBehavior);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;   free(triggerResetLayerName);</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;   free(initVTypeString);</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;   <span class="keywordflow">if</span> (thread_gSyn) {</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; parent-&gt;getNumThreads(); i++) {</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;         free(thread_gSyn[i]);</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;      }</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;      free(thread_gSyn);</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;   }</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;   <span class="keyword">delete</span> publisher;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;}</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="keywordtype">int</span> HyPerLayer::freeBuffer(T **buf) {</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;   free(*buf);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;   *buf = NULL;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;}</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment">// Declare the instantiations of allocateBuffer that occur in other .cpp files; otherwise you may</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">// get linker errors.</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keyword">template</span> <span class="keywordtype">int</span> HyPerLayer::freeBuffer&lt;float&gt;(<span class="keywordtype">float</span> **buf);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keyword">template</span> <span class="keywordtype">int</span> HyPerLayer::freeBuffer&lt;int&gt;(<span class="keywordtype">int</span> **buf);</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a5aa92946ff7292396576bccb72d60329">  254</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classPV_1_1HyPerLayer.html#a5aa92946ff7292396576bccb72d60329">HyPerLayer::freeRestrictedBuffer</a>(<span class="keywordtype">float</span> **buf) { <span class="keywordflow">return</span> freeBuffer(buf); }</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a59b5e16d1b64d30f990e2cc9c06a6cf6">  256</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classPV_1_1HyPerLayer.html#a59b5e16d1b64d30f990e2cc9c06a6cf6">HyPerLayer::freeExtendedBuffer</a>(<span class="keywordtype">float</span> **buf) { <span class="keywordflow">return</span> freeBuffer(buf); }</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="keywordtype">int</span> HyPerLayer::freeClayer() {</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;   pvcube_delete(clayer-&gt;activity);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;   freeBuffer(&amp;clayer-&gt;prevActivity);</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;   freeBuffer(&amp;clayer-&gt;V);</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;   free(clayer);</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;   clayer = NULL;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;}</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="keywordtype">void</span> HyPerLayer::freeChannels() {</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;   <span class="keywordflow">if</span> (d_GSyn != NULL) {</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      <span class="keyword">delete</span> d_GSyn;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      d_GSyn = NULL;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;   }</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDNN</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;   <span class="keywordflow">if</span> (cudnn_GSyn != NULL) {</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      <span class="keyword">delete</span> cudnn_GSyn;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;   }</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDNN</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;   <span class="comment">// GSyn gets allocated in allocateDataStructures, but only if numChannels&gt;0.</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;   <span class="keywordflow">if</span> (GSyn) {</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;      assert(numChannels &gt; 0);</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;      free(GSyn[0]); <span class="comment">// conductances allocated contiguously so frees all buffer storage</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      free(GSyn); <span class="comment">// this frees the array pointers to separate conductance channels</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;      GSyn        = NULL;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;      numChannels = 0;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;   }</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;}</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keywordtype">int</span> HyPerLayer::allocateClayerBuffers() {</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;   <span class="comment">// clayer fields numNeurons, numExtended, loc, xScale, yScale,</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;   <span class="comment">// dx, dy, xOrigin, yOrigin were set in initClayer().</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;   assert(clayer);</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;   allocateV();</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;   allocateActivity();</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;   <span class="comment">// athresher 11-4-16 TODO: Should these be called on non-spiking layers?</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;   allocatePrevActivity();</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; getNumExtendedAllBatches(); k++) {</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      clayer-&gt;prevActivity[k] = -10 * REFRACTORY_PERIOD; <span class="comment">// allow neuron to fire at time t==0</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;   }</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;}</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="keywordtype">void</span> HyPerLayer::allocateBuffer(T **buf, <span class="keywordtype">int</span> bufsize, <span class="keyword">const</span> <span class="keywordtype">char</span> *bufname) {</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;   *buf = (T *)calloc(bufsize, <span class="keyword">sizeof</span>(T));</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;   <span class="keywordflow">if</span> (*buf == NULL) {</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;      Fatal().printf(</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            <span class="stringliteral">&quot;%s: rank %d process unable to allocate memory for %s: %s.\n&quot;</span>,</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            getDescription_c(),</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            parent-&gt;columnId(),</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            bufname,</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            strerror(errno));</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;   }</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;}</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">// Declare the instantiations of allocateBuffer that occur in other .cpp files; otherwise you may</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">// get linker errors.</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="keyword">template</span> <span class="keywordtype">void</span> HyPerLayer::allocateBuffer&lt;float&gt;(<span class="keywordtype">float</span> **buf, <span class="keywordtype">int</span> bufsize, <span class="keyword">const</span> <span class="keywordtype">char</span> *bufname);</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="keyword">template</span> <span class="keywordtype">void</span> HyPerLayer::allocateBuffer&lt;int&gt;(<span class="keywordtype">int</span> **buf, <span class="keywordtype">int</span> bufsize, <span class="keyword">const</span> <span class="keywordtype">char</span> *bufname);</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#abea1a703930c35493f42ea38bf9a0118">  325</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#abea1a703930c35493f42ea38bf9a0118">HyPerLayer::allocateRestrictedBuffer</a>(<span class="keywordtype">float</span> **buf, <span class="keywordtype">char</span> <span class="keyword">const</span> *bufname) {</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;   allocateBuffer(buf, getNumNeuronsAllBatches(), bufname);</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;}</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a60536458c87edac02bd49815a7524662">  329</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a60536458c87edac02bd49815a7524662">HyPerLayer::allocateExtendedBuffer</a>(<span class="keywordtype">float</span> **buf, <span class="keywordtype">char</span> <span class="keyword">const</span> *bufname) {</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;   allocateBuffer(buf, getNumExtendedAllBatches(), bufname);</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;}</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordtype">void</span> HyPerLayer::allocateV() {</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;   <span class="keywordflow">return</span> <a class="code" href="classPV_1_1HyPerLayer.html#abea1a703930c35493f42ea38bf9a0118">allocateRestrictedBuffer</a>(&amp;clayer-&gt;V, <span class="stringliteral">&quot;membrane potential V&quot;</span>);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;}</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="keywordtype">void</span> HyPerLayer::allocateActivity() {</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;   clayer-&gt;activity = pvcube_new(&amp;clayer-&gt;loc, getNumExtendedAllBatches());</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;   FatalIf(</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;         clayer-&gt;activity == <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;%s failed to allocate activity cube.\n&quot;</span>, getDescription_c());</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;}</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordtype">void</span> HyPerLayer::allocatePrevActivity() {</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a60536458c87edac02bd49815a7524662">allocateExtendedBuffer</a>(&amp;clayer-&gt;prevActivity, <span class="stringliteral">&quot;time of previous activity&quot;</span>);</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;}</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="keywordtype">int</span> HyPerLayer::setLayerLoc(</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;      <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> *layerLoc,</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      <span class="keywordtype">float</span> nxScale,</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="keywordtype">float</span> nyScale,</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;      <span class="keywordtype">int</span> nf,</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;      <span class="keywordtype">int</span> numBatches) {</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;   <span class="keywordtype">int</span> status = PV_SUCCESS;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;   <a class="code" href="classPV_1_1Communicator.html">Communicator</a> *icComm = parent-&gt;getCommunicator();</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;   <span class="keywordtype">float</span> nxglobalfloat = nxScale * parent-&gt;getNxGlobal();</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;   layerLoc-&gt;nxGlobal  = (int)nearbyintf(nxglobalfloat);</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;   <span class="keywordflow">if</span> (std::fabs(nxglobalfloat - layerLoc-&gt;nxGlobal) &gt; 0.0001f) {</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;         ErrorLog(errorMessage);</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;               <span class="stringliteral">&quot;nxScale of layer \&quot;%s\&quot; is incompatible with size of column.\n&quot;</span>, getName());</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;               <span class="stringliteral">&quot;Column nx %d multiplied by nxScale %f must be an integer.\n&quot;</span>,</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;               (<span class="keywordtype">double</span>)parent-&gt;getNxGlobal(),</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;               (double)nxScale);</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      }</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;   }</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;   <span class="keywordtype">float</span> nyglobalfloat = nyScale * parent-&gt;getNyGlobal();</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;   layerLoc-&gt;nyGlobal  = (int)nearbyintf(nyglobalfloat);</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;   <span class="keywordflow">if</span> (std::fabs(nyglobalfloat - layerLoc-&gt;nyGlobal) &gt; 0.0001f) {</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;         ErrorLog(errorMessage);</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;               <span class="stringliteral">&quot;nyScale of layer \&quot;%s\&quot; is incompatible with size of column.\n&quot;</span>, getName());</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;               <span class="stringliteral">&quot;Column ny %d multiplied by nyScale %f must be an integer.\n&quot;</span>,</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;               (<span class="keywordtype">double</span>)parent-&gt;getNyGlobal(),</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;               (double)nyScale);</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;      }</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;   }</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;   <span class="comment">// partition input space based on the number of processor</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;   <span class="comment">// columns and rows</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;   <span class="comment">//</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;   <span class="keywordflow">if</span> (layerLoc-&gt;nxGlobal % icComm-&gt;numCommColumns() != 0) {</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;         ErrorLog(errorMessage);</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;               <span class="stringliteral">&quot;Size of HyPerLayer \&quot;%s\&quot; is not  compatible with the mpi configuration.\n&quot;</span>, name);</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;               <span class="stringliteral">&quot;The layer has %d pixels horizontally, and there are %d mpi processes in a row, but &quot;</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;               <span class="stringliteral">&quot;%d does not divide %d.\n&quot;</span>,</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;               layerLoc-&gt;nxGlobal,</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;               icComm-&gt;numCommColumns(),</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;               icComm-&gt;numCommColumns(),</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;               layerLoc-&gt;nxGlobal);</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;      }</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;   }</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;   <span class="keywordflow">if</span> (layerLoc-&gt;nyGlobal % icComm-&gt;numCommRows() != 0) {</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;         ErrorLog(errorMessage);</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;               <span class="stringliteral">&quot;Size of HyPerLayer \&quot;%s\&quot; is not  compatible with the mpi configuration.\n&quot;</span>, name);</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;         errorMessage.printf(</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;               <span class="stringliteral">&quot;The layer has %d pixels vertically, and there are %d mpi processes in a column, &quot;</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;               <span class="stringliteral">&quot;but %d does not divide %d.\n&quot;</span>,</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;               layerLoc-&gt;nyGlobal,</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;               icComm-&gt;numCommRows(),</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;               icComm-&gt;numCommRows(),</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;               layerLoc-&gt;nyGlobal);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      }</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;   }</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;   MPI_Barrier(icComm-&gt;communicator()); <span class="comment">// If there is an error, make sure that MPI doesn&#39;t kill the</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;   <span class="comment">// run before process 0 reports the error.</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;   <span class="keywordflow">if</span> (status != PV_SUCCESS) {</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;         ErrorLog().printf(<span class="stringliteral">&quot;setLayerLoc failed for %s.\n&quot;</span>, getDescription_c());</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      }</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      exit(EXIT_FAILURE);</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;   }</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;   layerLoc-&gt;nx = layerLoc-&gt;nxGlobal / icComm-&gt;numCommColumns();</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;   layerLoc-&gt;ny = layerLoc-&gt;nyGlobal / icComm-&gt;numCommRows();</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;   assert(layerLoc-&gt;nxGlobal == layerLoc-&gt;nx * icComm-&gt;numCommColumns());</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;   assert(layerLoc-&gt;nyGlobal == layerLoc-&gt;ny * icComm-&gt;numCommRows());</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;   layerLoc-&gt;kx0 = layerLoc-&gt;nx * icComm-&gt;commColumn();</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;   layerLoc-&gt;ky0 = layerLoc-&gt;ny * icComm-&gt;commRow();</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;   layerLoc-&gt;nf = nf;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;   layerLoc-&gt;nbatch = numBatches;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;   layerLoc-&gt;kb0          = parent-&gt;commBatch() * numBatches;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;   layerLoc-&gt;nbatchGlobal = parent-&gt;numCommBatches() * numBatches;</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;   <span class="comment">// halo is set in calls to updateClayerMargin</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;   layerLoc-&gt;halo.lt = 0;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;   layerLoc-&gt;halo.rt = 0;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;   layerLoc-&gt;halo.dn = 0;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;   layerLoc-&gt;halo.up = 0;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;}</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="keywordtype">void</span> HyPerLayer::calcNumExtended() {</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;   <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *loc = getLayerLoc();</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;   clayer-&gt;numExtended   = (loc-&gt;nx + loc-&gt;halo.lt + loc-&gt;halo.rt)</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                         * (loc-&gt;ny + loc-&gt;halo.dn + loc-&gt;halo.up) * loc-&gt;nf;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;   clayer-&gt;numExtendedAllBatches = clayer-&gt;numExtended * loc-&gt;nbatch;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;}</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="keywordtype">void</span> HyPerLayer::allocateBuffers() {</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;   <span class="comment">// allocate memory for input buffers.  For HyPerLayer, allocates GSyn</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;   <span class="comment">// virtual so that subclasses can initialize additional buffers if needed.</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;   <span class="comment">// Typically an overriding allocateBuffers should call HyPerLayer::allocateBuffers</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;   <span class="comment">// Specialized subclasses that don&#39;t use GSyn (e.g. CloneVLayer) should override</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;   <span class="comment">// allocateGSyn to do nothing.</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;   allocateGSyn();</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;}</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="keywordtype">void</span> HyPerLayer::allocateGSyn() {</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;   GSyn = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;   <span class="keywordflow">if</span> (numChannels &gt; 0) {</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      GSyn = (<span class="keywordtype">float</span> **)malloc(numChannels * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span> *));</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;      FatalIf(GSyn == <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;%s unable to allocate GSyn pointers.\n&quot;</span>, getDescription_c());</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      GSyn[0] = (<span class="keywordtype">float</span> *)calloc(getNumNeuronsAllBatches() * numChannels, <span class="keyword">sizeof</span>(float));</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      <span class="comment">// All channels allocated at once and contiguously.  resetGSynBuffers_HyPerLayer() assumes</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;      <span class="comment">// this is true, to make it easier to port to GPU.</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      FatalIf(GSyn[0] == <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;%s unable to allocate GSyn buffer.\n&quot;</span>, getDescription_c());</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 1; m &lt; numChannels; m++) {</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;         GSyn[m] = GSyn[0] + m * getNumNeuronsAllBatches();</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;      }</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;   }</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;}</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="keywordtype">void</span> HyPerLayer::addPublisher() {</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;   <a class="code" href="classPV_1_1MPIBlock.html">MPIBlock</a> <span class="keyword">const</span> *mpiBlock = parent-&gt;getCommunicator()-&gt;getLocalMPIBlock();</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;   publisher = <span class="keyword">new</span> <a class="code" href="classPV_1_1Publisher.html">Publisher</a>(*mpiBlock, clayer-&gt;activity, getNumDelayLevels(), getSparseFlag());</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;}</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="keywordtype">void</span> HyPerLayer::checkpointPvpActivityFloat(</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      <a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer,</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      <span class="keywordtype">char</span> <span class="keyword">const</span> *bufferName,</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;      <span class="keywordtype">float</span> *pvpBuffer,</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;      <span class="keywordtype">bool</span> extended) {</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;   <span class="keywordtype">bool</span> registerSucceeded = checkpointer-&gt;registerCheckpointEntry(</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;         std::make_shared&lt;<a class="code" href="classPV_1_1CheckpointEntryPvpBuffer.html">CheckpointEntryPvpBuffer&lt;float&gt;</a>&gt;(</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;               getName(),</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;               bufferName,</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;               checkpointer-&gt;getMPIBlock(),</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;               pvpBuffer,</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;               getLayerLoc(),</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;               extended),</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;         <span class="keyword">false</span> <span class="comment">/*not constant*/</span>);</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;   FatalIf(</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;         !registerSucceeded,</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;         <span class="stringliteral">&quot;%s failed to register %s for checkpointing.\n&quot;</span>,</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;         getDescription_c(),</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;         bufferName);</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;}</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="keywordtype">void</span> HyPerLayer::checkpointRandState(</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      <a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer,</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      <span class="keywordtype">char</span> <span class="keyword">const</span> *bufferName,</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      <a class="code" href="classPV_1_1Random.html">Random</a> *randState,</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      <span class="keywordtype">bool</span> extendedFlag) {</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;   <span class="keywordtype">bool</span> registerSucceeded = checkpointer-&gt;registerCheckpointEntry(</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;         std::make_shared&lt;CheckpointEntryRandState&gt;(</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;               getName(),</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;               bufferName,</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;               checkpointer-&gt;getMPIBlock(),</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;               randState-&gt;getRNG(0),</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;               getLayerLoc(),</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;               extendedFlag),</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;         <span class="keyword">false</span> <span class="comment">/*not constant*/</span>);</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;   FatalIf(</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;         !registerSucceeded,</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;         <span class="stringliteral">&quot;%s failed to register %s for checkpointing.\n&quot;</span>,</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;         getDescription_c(),</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;         bufferName);</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;}</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;Response::Status HyPerLayer::initializeState() {</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;   initializeV();</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;   initializeActivity();</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;}</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;Response::Status HyPerLayer::copyInitialStateToGPU() {</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;   <span class="keywordflow">if</span> (mUpdateGpu) {</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      <span class="keywordtype">float</span> *h_V = getV();</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      <span class="keywordflow">if</span> (h_V != NULL) {</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;         PVCuda::CudaBuffer *d_V = getDeviceV();</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;         assert(d_V);</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;         d_V-&gt;copyToDevice(h_V);</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;      }</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      PVCuda::CudaBuffer *d_activity = getDeviceActivity();</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      assert(d_activity);</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      <span class="keywordtype">float</span> *h_activity = getCLayer()-&gt;activity-&gt;data;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      d_activity-&gt;copyToDevice(h_activity);</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;   }</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;}</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="keywordtype">void</span> HyPerLayer::initializeV() {</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;   <span class="keywordflow">if</span> (getV() != <span class="keyword">nullptr</span> &amp;&amp; mInitVObject != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;      mInitVObject-&gt;calcV(getV(), getLayerLoc());</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;   }</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;}</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordtype">void</span> HyPerLayer::initializeActivity() {</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;   <span class="keywordtype">int</span> status = setActivity();</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;   FatalIf(status != PV_SUCCESS, <span class="stringliteral">&quot;%s failed to initialize activity.\n&quot;</span>, getDescription_c());</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;}</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div><div class="line"><a name="l00571"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#adf78265c6f0dc7bb94286934a9e5bd7a">  571</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classPV_1_1HyPerLayer.html#adf78265c6f0dc7bb94286934a9e5bd7a">HyPerLayer::ioParamsFillGroup</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;   <span class="comment">// Derived classes with new params behavior should override ioParamsFillGroup</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;   <span class="comment">// and the overriding method should call the base class&#39;s ioParamsFillGroup.</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a820c2695371eced2233ffd17d65bcd98">ioParam_nxScale</a>(ioFlag);</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#ad92d8a1d8ed7f9587ee6ef754d455366">ioParam_nyScale</a>(ioFlag);</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a38dbdd16a68095acea310a7f7003fa13">ioParam_nf</a>(ioFlag);</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a65e4c8eaa17655ef4c03147beed369b3">ioParam_phase</a>(ioFlag);</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a0d14e0e4bcfd9d10aa0918503ce4a7d6">ioParam_mirrorBCflag</a>(ioFlag);</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a69fcd09e34fbb76fc3e6434443c2fe0e">ioParam_valueBC</a>(ioFlag);</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a66b9f708d3e8f077a7b4fe8d51b4b138">ioParam_initializeFromCheckpointFlag</a>(ioFlag);</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a651cb7cee711755c35fd7d9b450cdf5e">ioParam_InitVType</a>(ioFlag);</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a4cb78e4b327b84207199f222cd79f808">ioParam_triggerLayerName</a>(ioFlag);</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#ae4df11ee53d2d7831ec931e5cbb4a6f9">ioParam_triggerFlag</a>(ioFlag);</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#abf47d71a0d1acabaebf97125c196f870">ioParam_triggerOffset</a>(ioFlag);</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a5cde54075d384518c5516f8c079ca26d">ioParam_triggerBehavior</a>(ioFlag);</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#aded80bac62512e73f789bd209933717f">ioParam_triggerResetLayerName</a>(ioFlag);</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a08b613ce7777b06a21ef20c85c739f4b">ioParam_writeStep</a>(ioFlag);</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a65fe374a6f26682e54bf1c132080ea1d">ioParam_initialWriteTime</a>(ioFlag);</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a20ef648236095449ebc8cc86716915ac">ioParam_sparseLayer</a>(ioFlag);</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#abca1bdde7c71b4ffa71aa30f5d0eba88">ioParam_writeSparseValues</a>(ioFlag);</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;   <span class="comment">// GPU-specific parameter.  If not using GPUs, this flag</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;   <span class="comment">// can be set to false or left out, but it is an error</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;   <span class="comment">// to set updateGpu to true if compiling without GPUs.</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html#a4604e955c54550237b44c4d4290655aa">ioParam_updateGpu</a>(ioFlag);</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;   ioParam_dataType(ioFlag);</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;}</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="keywordtype">void</span> HyPerLayer::ioParam_dataType(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;   this-&gt;parent-&gt;parameters()-&gt;ioParamString(</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;         ioFlag, this-&gt;getName(), <span class="stringliteral">&quot;dataType&quot;</span>, &amp;dataTypeString, NULL, <span class="keyword">false</span> <span class="comment">/*warnIfAbsent*/</span>);</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;   <span class="keywordflow">if</span> (dataTypeString == NULL) {</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      <span class="comment">// Default value</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      dataType = PV_FLOAT;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;   }</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;   <span class="keywordflow">if</span> (!strcmp(dataTypeString, <span class="stringliteral">&quot;float&quot;</span>)) {</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      dataType = PV_FLOAT;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;   }</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(dataTypeString, <span class="stringliteral">&quot;int&quot;</span>)) {</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      dataType = PV_INT;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;   }</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;      Fatal() &lt;&lt; <span class="stringliteral">&quot;BaseLayer \&quot;&quot;</span> &lt;&lt; name</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;              &lt;&lt; <span class="stringliteral">&quot;\&quot;: dataType not recognized, can be \&quot;float\&quot; or \&quot;int\&quot;\n&quot;</span>;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;   }</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;}</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a4604e955c54550237b44c4d4290655aa">  621</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a4604e955c54550237b44c4d4290655aa">HyPerLayer::ioParam_updateGpu</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;         ioFlag, name, <span class="stringliteral">&quot;updateGpu&quot;</span>, &amp;mUpdateGpu, mUpdateGpu, <span class="keyword">true</span> <span class="comment">/*warnIfAbsent*/</span>);</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;   mUsingGPUFlag = mUpdateGpu;</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="preprocessor">#else // PV_USE_CUDA</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;   <span class="keywordtype">bool</span> mUpdateGpu = <span class="keyword">false</span>;</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;         ioFlag, name, <span class="stringliteral">&quot;updateGpu&quot;</span>, &amp;mUpdateGpu, mUpdateGpu, <span class="keyword">false</span> <span class="comment">/*warnIfAbsent*/</span>);</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;   <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      FatalIf(</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            mUpdateGpu,</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            <span class="stringliteral">&quot;%s: updateGpu is set to true, but PetaVision was compiled without GPU acceleration.\n&quot;</span>,</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            getDescription_c());</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;   }</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;}</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a820c2695371eced2233ffd17d65bcd98">  639</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a820c2695371eced2233ffd17d65bcd98">HyPerLayer::ioParam_nxScale</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;nxScale&quot;</span>, &amp;nxScale, nxScale);</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;}</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div><div class="line"><a name="l00643"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#ad92d8a1d8ed7f9587ee6ef754d455366">  643</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#ad92d8a1d8ed7f9587ee6ef754d455366">HyPerLayer::ioParam_nyScale</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;nyScale&quot;</span>, &amp;nyScale, nyScale);</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;}</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div><div class="line"><a name="l00647"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a38dbdd16a68095acea310a7f7003fa13">  647</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a38dbdd16a68095acea310a7f7003fa13">HyPerLayer::ioParam_nf</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;nf&quot;</span>, &amp;numFeatures, numFeatures);</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;}</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a65e4c8eaa17655ef4c03147beed369b3">  651</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a65e4c8eaa17655ef4c03147beed369b3">HyPerLayer::ioParam_phase</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;phase&quot;</span>, &amp;phase, phase);</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;   <span class="keywordflow">if</span> (ioFlag == PARAMS_IO_READ &amp;&amp; phase &lt; 0) {</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0)</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;         Fatal().printf(</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;               <span class="stringliteral">&quot;%s: phase must be &gt;= 0 (given value was %d).\n&quot;</span>, getDescription_c(), phase);</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;   }</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;}</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div><div class="line"><a name="l00660"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a0d14e0e4bcfd9d10aa0918503ce4a7d6">  660</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a0d14e0e4bcfd9d10aa0918503ce4a7d6">HyPerLayer::ioParam_mirrorBCflag</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;mirrorBCflag&quot;</span>, &amp;mirrorBCflag, mirrorBCflag);</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;}</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div><div class="line"><a name="l00664"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a69fcd09e34fbb76fc3e6434443c2fe0e">  664</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a69fcd09e34fbb76fc3e6434443c2fe0e">HyPerLayer::ioParam_valueBC</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;   assert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;mirrorBCflag&quot;</span>));</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;   <span class="keywordflow">if</span> (!mirrorBCflag) {</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;valueBC&quot;</span>, &amp;valueBC, (<span class="keywordtype">float</span>)0);</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;   }</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;}</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div><div class="line"><a name="l00671"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a66b9f708d3e8f077a7b4fe8d51b4b138">  671</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a66b9f708d3e8f077a7b4fe8d51b4b138">HyPerLayer::ioParam_initializeFromCheckpointFlag</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;         ioFlag,</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;         name,</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;         <span class="stringliteral">&quot;initializeFromCheckpointFlag&quot;</span>,</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;         &amp;initializeFromCheckpointFlag,</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;         initializeFromCheckpointFlag,</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;         <span class="keyword">true</span> <span class="comment">/*warnIfAbsent*/</span>);</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;}</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div><div class="line"><a name="l00681"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a651cb7cee711755c35fd7d9b450cdf5e">  681</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a651cb7cee711755c35fd7d9b450cdf5e">HyPerLayer::ioParam_InitVType</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;   parent-&gt;parameters()-&gt;ioParamString(</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;         ioFlag,</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;         name,</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;         <span class="stringliteral">&quot;InitVType&quot;</span>,</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;         &amp;initVTypeString,</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;         BaseInitV::mDefaultInitV.data(),</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;         <span class="keyword">true</span> <span class="comment">/*warnIfAbsent*/</span>);</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;   <span class="keywordflow">if</span> (ioFlag == PARAMS_IO_READ) {</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;      <a class="code" href="classPV_1_1BaseObject.html">BaseObject</a> *<span class="keywordtype">object</span> = Factory::instance()-&gt;createByKeyword(initVTypeString, name, parent);</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      mInitVObject       = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classPV_1_1BaseInitV.html">BaseInitV</a> *<span class="keyword">&gt;</span>(object);</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      <span class="keywordflow">if</span> (mInitVObject == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;         ErrorLog().printf(<span class="stringliteral">&quot;%s: unable to create InitV object\n&quot;</span>, getDescription_c());</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;         abort();</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      }</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;   }</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;   <span class="keywordflow">if</span> (mInitVObject != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      mInitVObject-&gt;<a class="code" href="classPV_1_1BaseInitV.html#a2c8dbf874a7bbcabed1af1ac71b73756">ioParamsFillGroup</a>(ioFlag);</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;   }</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;}</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a4cb78e4b327b84207199f222cd79f808">  702</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a4cb78e4b327b84207199f222cd79f808">HyPerLayer::ioParam_triggerLayerName</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;   parent-&gt;parameters()-&gt;ioParamString(</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;         ioFlag, name, <span class="stringliteral">&quot;triggerLayerName&quot;</span>, &amp;triggerLayerName, NULL, <span class="keyword">false</span> <span class="comment">/*warnIfAbsent*/</span>);</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;   <span class="keywordflow">if</span> (ioFlag == PARAMS_IO_READ) {</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;      <span class="keywordflow">if</span> (triggerLayerName &amp;&amp; !strcmp(name, triggerLayerName)) {</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;         <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            ErrorLog().printf(</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                  <span class="stringliteral">&quot;%s: triggerLayerName cannot be the same as the name of the layer itself.\n&quot;</span>,</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                  getDescription_c());</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;         }</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;         MPI_Barrier(parent-&gt;getCommunicator()-&gt;communicator());</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;         exit(EXIT_FAILURE);</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;      }</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;      triggerFlag = (triggerLayerName != NULL &amp;&amp; triggerLayerName[0] != <span class="charliteral">&#39;\0&#39;</span>);</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;   }</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;}</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment">// triggerFlag was deprecated Aug 7, 2015.</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">// Setting triggerLayerName to a nonempty string has the effect of triggerFlag=true, and</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="comment">// setting triggerLayerName to NULL or &quot;&quot; has the effect of triggerFlag=false.</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment">// While triggerFlag is being deprecated, it is an error for triggerFlag to be false</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">// and triggerLayerName to be a nonempty string.</span></div><div class="line"><a name="l00724"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#ae4df11ee53d2d7831ec931e5cbb4a6f9">  724</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#ae4df11ee53d2d7831ec931e5cbb4a6f9">HyPerLayer::ioParam_triggerFlag</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;   pvAssert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;triggerLayerName&quot;</span>));</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;   <span class="keywordflow">if</span> (ioFlag == PARAMS_IO_READ &amp;&amp; parent-&gt;parameters()-&gt;<a class="code" href="classPV_1_1PVParams.html#ab1216243eb516e4fc5fdb3255005d10f">present</a>(name, <span class="stringliteral">&quot;triggerFlag&quot;</span>)) {</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;      <span class="keywordtype">bool</span> flagFromParams = <span class="keyword">false</span>;</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;      parent-&gt;parameters()-&gt;ioParamValue(</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            ioFlag, name, <span class="stringliteral">&quot;triggerFlag&quot;</span>, &amp;flagFromParams, flagFromParams);</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;         WarnLog(triggerFlagMessage);</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;         triggerFlagMessage.printf(<span class="stringliteral">&quot;%s: triggerFlag has been deprecated.\n&quot;</span>, getDescription_c());</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;         triggerFlagMessage.printf(</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;               <span class="stringliteral">&quot;   If triggerLayerName is a nonempty string, triggering will be on;\n&quot;</span>);</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;         triggerFlagMessage.printf(</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;               <span class="stringliteral">&quot;   if triggerLayerName is empty or null, triggering will be off.\n&quot;</span>);</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;         <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;            <span class="keywordflow">if</span> (flagFromParams != triggerFlag) {</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;               ErrorLog(errorMessage);</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;               errorMessage.printf(<span class="stringliteral">&quot;triggerLayerName=&quot;</span>, name);</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;               <span class="keywordflow">if</span> (triggerLayerName) {</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                  errorMessage.printf(<span class="stringliteral">&quot;\&quot;%s\&quot;&quot;</span>, triggerLayerName);</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;               }</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;               <span class="keywordflow">else</span> {</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                  errorMessage.printf(<span class="stringliteral">&quot;NULL&quot;</span>);</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;               }</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;               errorMessage.printf(</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                     <span class="stringliteral">&quot; implies triggerFlag=%s but triggerFlag was set in params to %s\n&quot;</span>,</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                     triggerFlag ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>,</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                     flagFromParams ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;            }</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;         }</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;      }</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;      <span class="keywordflow">if</span> (flagFromParams != triggerFlag) {</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;         MPI_Barrier(parent-&gt;getCommunicator()-&gt;communicator());</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;         exit(EXIT_FAILURE);</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;      }</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;   }</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;}</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;</div><div class="line"><a name="l00761"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#abf47d71a0d1acabaebf97125c196f870">  761</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#abf47d71a0d1acabaebf97125c196f870">HyPerLayer::ioParam_triggerOffset</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;   assert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;triggerLayerName&quot;</span>));</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;   <span class="keywordflow">if</span> (triggerFlag) {</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      parent-&gt;parameters()-&gt;ioParamValue(</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;            ioFlag, name, <span class="stringliteral">&quot;triggerOffset&quot;</span>, &amp;triggerOffset, triggerOffset);</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;      <span class="keywordflow">if</span> (triggerOffset &lt; 0) {</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;         <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;            Fatal().printf(</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                  <span class="stringliteral">&quot;%s: TriggerOffset (%f) must be positive\n&quot;</span>, getDescription_c(), triggerOffset);</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;         }</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      }</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;   }</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;}</div><div class="line"><a name="l00774"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a5cde54075d384518c5516f8c079ca26d">  774</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a5cde54075d384518c5516f8c079ca26d">HyPerLayer::ioParam_triggerBehavior</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;   assert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;triggerLayerName&quot;</span>));</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;   <span class="keywordflow">if</span> (triggerFlag) {</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;      parent-&gt;parameters()-&gt;ioParamString(</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;            ioFlag,</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;            name,</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;            <span class="stringliteral">&quot;triggerBehavior&quot;</span>,</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;            &amp;triggerBehavior,</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;            <span class="stringliteral">&quot;updateOnlyOnTrigger&quot;</span>,</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;            <span class="keyword">true</span> <span class="comment">/*warnIfAbsent*/</span>);</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;      <span class="keywordflow">if</span> (triggerBehavior == NULL || !strcmp(triggerBehavior, <span class="stringliteral">&quot;&quot;</span>)) {</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;         free(triggerBehavior);</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;         triggerBehavior     = strdup(<span class="stringliteral">&quot;updateOnlyOnTrigger&quot;</span>);</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;         triggerBehaviorType = UPDATEONLY_TRIGGER;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;      }</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(triggerBehavior, <span class="stringliteral">&quot;updateOnlyOnTrigger&quot;</span>)) {</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;         triggerBehaviorType = UPDATEONLY_TRIGGER;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;      }</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(triggerBehavior, <span class="stringliteral">&quot;resetStateOnTrigger&quot;</span>)) {</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;         triggerBehaviorType = RESETSTATE_TRIGGER;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;      }</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(triggerBehavior, <span class="stringliteral">&quot;ignore&quot;</span>)) {</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;         triggerBehaviorType = NO_TRIGGER;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;      }</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;         <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;            ErrorLog().printf(</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                  <span class="stringliteral">&quot;%s: triggerBehavior=\&quot;%s\&quot; is unrecognized.\n&quot;</span>,</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                  getDescription_c(),</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                  triggerBehavior);</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;         }</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;         MPI_Barrier(parent-&gt;getCommunicator()-&gt;communicator());</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;         exit(EXIT_FAILURE);</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;      }</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;   }</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;      triggerBehaviorType = NO_TRIGGER;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;   }</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;}</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div><div class="line"><a name="l00814"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#aded80bac62512e73f789bd209933717f">  814</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#aded80bac62512e73f789bd209933717f">HyPerLayer::ioParam_triggerResetLayerName</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;   assert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;triggerLayerName&quot;</span>));</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;   <span class="keywordflow">if</span> (triggerFlag) {</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;      assert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;triggerBehavior&quot;</span>));</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;      <span class="keywordflow">if</span> (!strcmp(triggerBehavior, <span class="stringliteral">&quot;resetStateOnTrigger&quot;</span>)) {</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;         parent-&gt;parameters()-&gt;ioParamStringRequired(</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;               ioFlag, name, <span class="stringliteral">&quot;triggerResetLayerName&quot;</span>, &amp;triggerResetLayerName);</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;      }</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;   }</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;}</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div><div class="line"><a name="l00825"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a08b613ce7777b06a21ef20c85c739f4b">  825</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a08b613ce7777b06a21ef20c85c739f4b">HyPerLayer::ioParam_writeStep</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;         ioFlag, name, <span class="stringliteral">&quot;writeStep&quot;</span>, &amp;writeStep, parent-&gt;getDeltaTime());</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;}</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a65fe374a6f26682e54bf1c132080ea1d">  830</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a65fe374a6f26682e54bf1c132080ea1d">HyPerLayer::ioParam_initialWriteTime</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;   assert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;writeStep&quot;</span>));</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;   <span class="keywordflow">if</span> (writeStep &gt;= 0.0) {</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;initialWriteTime&quot;</span>, &amp;initialWriteTime, 0.0);</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      <span class="keywordflow">if</span> (ioFlag == PARAMS_IO_READ &amp;&amp; writeStep &gt; 0.0 &amp;&amp; initialWriteTime &lt; 0.0) {</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;         <span class="keywordtype">double</span> storeInitialWriteTime = initialWriteTime;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;         <span class="keywordflow">while</span> (initialWriteTime &lt; 0.0) {</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;            initialWriteTime += writeStep;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;         }</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;         <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;            WarnLog(warningMessage);</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;            warningMessage.printf(</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                  <span class="stringliteral">&quot;%s: initialWriteTime %f is negative.  Adjusting &quot;</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                  <span class="stringliteral">&quot;initialWriteTime:\n&quot;</span>,</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                  getDescription_c(),</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                  initialWriteTime);</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;            warningMessage.printf(<span class="stringliteral">&quot;    initialWriteTime adjusted to %f\n&quot;</span>, initialWriteTime);</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;         }</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;      }</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;   }</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;}</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div><div class="line"><a name="l00852"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a20ef648236095449ebc8cc86716915ac">  852</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a20ef648236095449ebc8cc86716915ac">HyPerLayer::ioParam_sparseLayer</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;   <span class="keywordflow">if</span> (ioFlag == PARAMS_IO_READ &amp;&amp; !parent-&gt;parameters()-&gt;<a class="code" href="classPV_1_1PVParams.html#ab1216243eb516e4fc5fdb3255005d10f">present</a>(name, <span class="stringliteral">&quot;sparseLayer&quot;</span>)</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;       &amp;&amp; parent-&gt;parameters()-&gt;<a class="code" href="classPV_1_1PVParams.html#ab1216243eb516e4fc5fdb3255005d10f">present</a>(name, <span class="stringliteral">&quot;writeSparseActivity&quot;</span>)) {</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;      Fatal().printf(<span class="stringliteral">&quot;writeSparseActivity is obsolete. Use sparseLayer instead.\n&quot;</span>);</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;   }</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;   <span class="comment">// writeSparseActivity was deprecated Nov 4, 2014 and marked obsolete Mar 14, 2017.</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;   parent-&gt;parameters()-&gt;ioParamValue(ioFlag, name, <span class="stringliteral">&quot;sparseLayer&quot;</span>, &amp;sparseLayer, <span class="keyword">false</span>);</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;}</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="comment">// writeSparseValues is obsolete as of Mar 14, 2017.</span></div><div class="line"><a name="l00862"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#abca1bdde7c71b4ffa71aa30f5d0eba88">  862</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#abca1bdde7c71b4ffa71aa30f5d0eba88">HyPerLayer::ioParam_writeSparseValues</a>(<span class="keyword">enum</span> ParamsIOFlag ioFlag) {</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;   <span class="keywordflow">if</span> (ioFlag == PARAMS_IO_READ) {</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      assert(!parent-&gt;parameters()-&gt;presentAndNotBeenRead(name, <span class="stringliteral">&quot;sparseLayer&quot;</span>));</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      <span class="keywordflow">if</span> (sparseLayer &amp;&amp; parent-&gt;parameters()-&gt;<a class="code" href="classPV_1_1PVParams.html#ab1216243eb516e4fc5fdb3255005d10f">present</a>(name, <span class="stringliteral">&quot;writeSparseValues&quot;</span>)) {</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;         WarnLog() &lt;&lt; <span class="stringliteral">&quot;writeSparseValues parameter, defined in &quot;</span> &lt;&lt; getDescription()</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                   &lt;&lt; <span class="stringliteral">&quot;, is obsolete.\n&quot;</span>;</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;         <span class="keywordtype">bool</span> writeSparseValues;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;         parent-&gt;parameters()-&gt;ioParamValue(</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;               ioFlag, name, <span class="stringliteral">&quot;writeSparseValues&quot;</span>, &amp;writeSparseValues, <span class="keyword">true</span> <span class="comment">/*default value*/</span>);</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;         <span class="keywordflow">if</span> (!writeSparseValues) {</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            WarnLog() &lt;&lt; <span class="stringliteral">&quot;The sparse-values format is used for all sparse layers.\n&quot;</span>;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;         }</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;      }</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;   }</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;}</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;Response::Status HyPerLayer::respond(std::shared_ptr&lt;BaseMessage const&gt; message) {</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;   Response::Status status = BaseLayer::respond(message);</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;   <span class="keywordflow">if</span> (status != Response::SUCCESS) {</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;   }</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> castMessage = std::dynamic_pointer_cast&lt;LayerSetMaxPhaseMessage const&gt;(message)) {</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;      <span class="keywordflow">return</span> respondLayerSetMaxPhase(castMessage);</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;   }</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> castMessage = std::dynamic_pointer_cast&lt;LayerWriteParamsMessage const&gt;(message)) {</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="keywordflow">return</span> respondLayerWriteParams(castMessage);</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;   }</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;         <span class="keyword">auto</span> castMessage =</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;               std::dynamic_pointer_cast&lt;LayerProbeWriteParamsMessage const&gt;(message)) {</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;      <span class="keywordflow">return</span> respondLayerProbeWriteParams(castMessage);</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;   }</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;         <span class="keyword">auto</span> castMessage =</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;               std::dynamic_pointer_cast&lt;LayerClearProgressFlagsMessage const&gt;(message)) {</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;      <span class="keywordflow">return</span> respondLayerClearProgressFlags(castMessage);</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;   }</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> castMessage = std::dynamic_pointer_cast&lt;LayerUpdateStateMessage const&gt;(message)) {</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;      <span class="keywordflow">return</span> respondLayerUpdateState(castMessage);</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;   }</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;         <span class="keyword">auto</span> castMessage =</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;               std::dynamic_pointer_cast&lt;LayerRecvSynapticInputMessage const&gt;(message)) {</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      <span class="keywordflow">return</span> respondLayerRecvSynapticInput(castMessage);</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;   }</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> castMessage = std::dynamic_pointer_cast&lt;LayerCopyFromGpuMessage const&gt;(message)) {</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;      <span class="keywordflow">return</span> respondLayerCopyFromGpu(castMessage);</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;   }</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;         <span class="keyword">auto</span> castMessage =</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;               std::dynamic_pointer_cast&lt;LayerAdvanceDataStoreMessage const&gt;(message)) {</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;      <span class="keywordflow">return</span> respondLayerAdvanceDataStore(castMessage);</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;   }</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> castMessage = std::dynamic_pointer_cast&lt;LayerPublishMessage const&gt;(message)) {</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;      <span class="keywordflow">return</span> respondLayerPublish(castMessage);</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;   }</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> castMessage = std::dynamic_pointer_cast&lt;LayerOutputStateMessage const&gt;(message)) {</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;      <span class="keywordflow">return</span> respondLayerOutputState(castMessage);</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;   }</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;         <span class="keyword">auto</span> castMessage = std::dynamic_pointer_cast&lt;LayerCheckNotANumberMessage const&gt;(message)) {</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;      <span class="keywordflow">return</span> respondLayerCheckNotANumber(castMessage);</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;   }</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;   }</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;}</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;Response::Status</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;HyPerLayer::respondLayerSetMaxPhase(std::shared_ptr&lt;LayerSetMaxPhaseMessage const&gt; message) {</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;   <span class="keywordflow">return</span> setMaxPhase(message-&gt;mMaxPhase);</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;}</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;Response::Status</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;HyPerLayer::respondLayerWriteParams(std::shared_ptr&lt;LayerWriteParamsMessage const&gt; message) {</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;   <a class="code" href="classPV_1_1BaseObject.html#a2b24e49874218ac1b84418df1d9410ad">writeParams</a>();</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;}</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;Response::Status HyPerLayer::respondLayerProbeWriteParams(</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;      std::shared_ptr&lt;LayerProbeWriteParamsMessage const&gt; message) {</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;   <span class="keywordflow">return</span> outputProbeParams();</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;}</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;Response::Status HyPerLayer::respondLayerClearProgressFlags(</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;      std::shared_ptr&lt;LayerClearProgressFlagsMessage const&gt; message) {</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;   clearProgressFlags();</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;}</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;Response::Status HyPerLayer::respondLayerRecvSynapticInput(</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;      std::shared_ptr&lt;LayerRecvSynapticInputMessage const&gt; message) {</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;   Response::Status status = Response::SUCCESS;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mPhase != getPhase()) {</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;   }</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mRecvOnGpuFlag != mRecvGpu) {</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;   }</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;   <span class="keywordflow">if</span> (mHasReceived) {</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;   }</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;   <span class="keywordflow">if</span> (*(message-&gt;mSomeLayerHasActed) or !<a class="code" href="classPV_1_1HyPerLayer.html#a2e384c9ee929aef35ba67c526ff78fd2">isAllInputReady</a>()) {</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;      *(message-&gt;mSomeLayerIsPending) = <span class="keyword">true</span>;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;   }</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;   resetGSynBuffers(message-&gt;mTime, message-&gt;mDeltaT); <span class="comment">// deltaTimeAdapt is not used</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;   message-&gt;mTimer-&gt;start();</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;   recvAllSynapticInput();</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;   mHasReceived                   = <span class="keyword">true</span>;</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;   *(message-&gt;mSomeLayerHasActed) = <span class="keyword">true</span>;</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;   message-&gt;mTimer-&gt;stop();</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;}</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;Response::Status</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;HyPerLayer::respondLayerUpdateState(std::shared_ptr&lt;LayerUpdateStateMessage const&gt; message) {</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;   Response::Status status = Response::SUCCESS;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mPhase != getPhase()) {</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;   }</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mRecvOnGpuFlag != mRecvGpu) {</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;   }</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mUpdateOnGpuFlag != mUpdateGpu) {</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;   }</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;   <span class="keywordflow">if</span> (mHasUpdated) {</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;   }</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;   <span class="keywordflow">if</span> (*(message-&gt;mSomeLayerHasActed) or !mHasReceived) {</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;      *(message-&gt;mSomeLayerIsPending) = <span class="keyword">true</span>;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;   }</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;   status = callUpdateState(message-&gt;mTime, message-&gt;mDeltaT);</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;   mHasUpdated                    = <span class="keyword">true</span>;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;   *(message-&gt;mSomeLayerHasActed) = <span class="keyword">true</span>;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;}</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;Response::Status</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;HyPerLayer::respondLayerCopyFromGpu(std::shared_ptr&lt;LayerCopyFromGpuMessage const&gt; message) {</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;   Response::Status status = Response::SUCCESS;</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mPhase != getPhase()) {</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;   }</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;   message-&gt;mTimer-&gt;start();</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;   copyAllActivityFromDevice();</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;   copyAllVFromDevice();</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;   copyAllGSynFromDevice();</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;   addGpuTimers();</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;   message-&gt;mTimer-&gt;stop();</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;}</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;Response::Status HyPerLayer::respondLayerAdvanceDataStore(</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;      std::shared_ptr&lt;LayerAdvanceDataStoreMessage const&gt; message) {</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mPhase &lt; 0 || message-&gt;mPhase == getPhase()) {</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      publisher-&gt;increaseTimeLevel();</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;   }</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;}</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;Response::Status</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;HyPerLayer::respondLayerPublish(std::shared_ptr&lt;LayerPublishMessage const&gt; message) {</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mPhase != getPhase()) {</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;      <span class="keywordflow">return</span> Response::NO_ACTION;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;   }</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;   publish(parent-&gt;getCommunicator(), message-&gt;mTime);</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;}</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;Response::Status HyPerLayer::respondLayerCheckNotANumber(</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;      std::shared_ptr&lt;LayerCheckNotANumberMessage const&gt; message) {</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;   Response::Status status = Response::SUCCESS;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mPhase != getPhase()) {</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;   }</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;   <span class="keyword">auto</span> layerData = <a class="code" href="classPV_1_1HyPerLayer.html#a09e35d33646f5a6dc1e0a81e75de1839">getLayerData</a>();</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> N    = getNumExtendedAllBatches();</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 0; n &lt; N; n++) {</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;      <span class="keywordtype">float</span> a = layerData[n];</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;      FatalIf(</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;            a != a,</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;            <span class="stringliteral">&quot;%s has not-a-number values in the activity buffer.  Exiting.\n&quot;</span>,</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;            getDescription_c());</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;   }</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;}</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;Response::Status</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;HyPerLayer::respondLayerOutputState(std::shared_ptr&lt;LayerOutputStateMessage const&gt; message) {</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;   Response::Status status = Response::SUCCESS;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;   <span class="keywordflow">if</span> (message-&gt;mPhase != getPhase()) {</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;   }</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;   status = outputState(message-&gt;mTime); <span class="comment">// also calls layer probes&#39; outputState</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;}</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="keywordtype">void</span> HyPerLayer::clearProgressFlags() {</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;   mHasReceived = <span class="keyword">false</span>;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;   mHasUpdated  = <span class="keyword">false</span>;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;}</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="keywordtype">int</span> HyPerLayer::allocateUpdateKernel() {</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;   Fatal() &lt;&lt; <span class="stringliteral">&quot;Layer \&quot;&quot;</span> &lt;&lt; name &lt;&lt; <span class="stringliteral">&quot;\&quot; of type &quot;</span> &lt;&lt; mObjectType</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; does not support updating on gpus yet\n&quot;</span>;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;   <span class="keywordflow">return</span> PV_FAILURE;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;}</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;</div><div class="line"><a name="l01090"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#af6bf682a8b67348ca0cf200a9ba3a44b"> 1090</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classPV_1_1HyPerLayer.html#af6bf682a8b67348ca0cf200a9ba3a44b">HyPerLayer::allocateDeviceBuffers</a>() {</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;   <span class="keywordtype">int</span> status = 0;</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">size_t</span> size    = getNumNeuronsAllBatches() * <span class="keyword">sizeof</span>(float);</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;   <span class="keyword">const</span> <span class="keywordtype">size_t</span> size_ex = getNumExtendedAllBatches() * <span class="keyword">sizeof</span>(float);</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;   PVCuda::CudaDevice *device = parent-&gt;getDevice();</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;   <span class="comment">// Allocate based on which flags are set</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;   <span class="keywordflow">if</span> (allocDeviceV) {</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;      d_V = device-&gt;createBuffer(size, &amp;description);</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;   }</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;   <span class="keywordflow">if</span> (allocDeviceDatastore) {</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;      d_Datastore = device-&gt;createBuffer(size_ex, &amp;description);</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;      assert(d_Datastore);</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDNN</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;      cudnn_Datastore = device-&gt;createBuffer(size_ex, &amp;description);</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;      assert(cudnn_Datastore);</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;   }</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;   <span class="keywordflow">if</span> (allocDeviceActiveIndices) {</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;      d_numActive     = device-&gt;createBuffer(parent-&gt;getNBatch() * <span class="keyword">sizeof</span>(long), &amp;description);</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;      d_ActiveIndices = device-&gt;createBuffer(</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;            getNumExtendedAllBatches() * <span class="keyword">sizeof</span>(<a class="code" href="classPV_1_1SparseList.html">SparseList&lt;float&gt;::Entry</a>), &amp;description);</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;      assert(d_ActiveIndices);</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;   }</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;   <span class="keywordflow">if</span> (allocDeviceActivity) {</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;      d_Activity = device-&gt;createBuffer(size_ex, &amp;description);</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;   }</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;   <span class="comment">// d_GSyn is the entire gsyn buffer. cudnn_GSyn is only one gsyn channel</span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;   <span class="keywordflow">if</span> (allocDeviceGSyn) {</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;      d_GSyn = device-&gt;createBuffer(size * numChannels, &amp;description);</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;      assert(d_GSyn);</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDNN</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;      cudnn_GSyn = device-&gt;createBuffer(size, &amp;description);</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;   }</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;}</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;Response::Status</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;HyPerLayer::communicateInitInfo(std::shared_ptr&lt;CommunicateInitInfoMessage const&gt; message) {</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;   <span class="comment">// HyPerLayers need to tell the parent HyPerCol how many random number</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;   <span class="comment">// seeds they need.  At the start of HyPerCol::run, the parent HyPerCol</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;   <span class="comment">// calls each layer&#39;s communicateInitInfo() sequentially in a repeatable order</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;   <span class="comment">// (probably the order the layers appear in the params file) to make sure</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;   <span class="comment">// that the same runs use the same RNG seeds in the same way.</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;   <span class="comment">//</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;   <span class="comment">// If any other object in the column needs the layer to have a certain minimum</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;   <span class="comment">// margin width (e.g. a HyPerConn with patch size bigger than one), it should</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;   <span class="comment">// call the layer&#39;s requireMarginWidth() method during its communicateInitInfo</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;   <span class="comment">// stage.</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;   <span class="comment">//</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;   <span class="comment">// Since all communicateInitInfo() methods are called before any allocateDataStructures()</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;   <span class="comment">// methods, HyPerLayer knows its marginWidth before it has to allocate</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;   <span class="comment">// anything.  So the margin width does not have to be specified in params.</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;   <span class="keywordflow">if</span> (triggerFlag) {</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;      triggerLayer = message-&gt;lookup&lt;<a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a>&gt;(std::string(triggerLayerName));</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;      <span class="keywordflow">if</span> (triggerLayer == NULL) {</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;         <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;            ErrorLog().printf(</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;                  <span class="stringliteral">&quot;%s: triggerLayerName \&quot;%s\&quot; is not a layer in the HyPerCol.\n&quot;</span>,</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                  getDescription_c(),</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                  triggerLayerName);</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;         }</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;         MPI_Barrier(parent-&gt;getCommunicator()-&gt;communicator());</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;         exit(EXIT_FAILURE);</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;      }</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      <span class="keywordflow">if</span> (triggerBehaviorType == RESETSTATE_TRIGGER) {</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;         <span class="keywordtype">char</span> <span class="keyword">const</span> *resetLayerName = NULL; <span class="comment">// Will point to name of actual resetLayer, whether</span></div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;         <span class="comment">// triggerResetLayerName is blank (in which case</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;         <span class="comment">// resetLayerName==triggerLayerName) or not</span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;         <span class="keywordflow">if</span> (triggerResetLayerName == NULL || triggerResetLayerName[0] == <span class="charliteral">&#39;\0&#39;</span>) {</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;            resetLayerName    = triggerLayerName;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;            triggerResetLayer = triggerLayer;</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;         }</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;         <span class="keywordflow">else</span> {</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;            resetLayerName    = triggerResetLayerName;</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;            triggerResetLayer = message-&gt;lookup&lt;<a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a>&gt;(std::string(triggerResetLayerName));</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;            <span class="keywordflow">if</span> (triggerResetLayer == NULL) {</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;               <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                  ErrorLog().printf(</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                        <span class="stringliteral">&quot;%s: triggerResetLayerName \&quot;%s\&quot; is not a layer in the HyPerCol.\n&quot;</span>,</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                        getDescription_c(),</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;                        triggerResetLayerName);</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;               }</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;               MPI_Barrier(parent-&gt;getCommunicator()-&gt;communicator());</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;               exit(EXIT_FAILURE);</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;            }</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;         }</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;         <span class="comment">// Check that triggerResetLayer and this layer have the same (restricted) dimensions.</span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;         <span class="comment">// Do we need to postpone until triggerResetLayer has finished its communicateInitInfo?</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;         <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *triggerLoc = triggerResetLayer-&gt;getLayerLoc();</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;         <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *localLoc   = this-&gt;getLayerLoc();</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;         <span class="keywordflow">if</span> (triggerLoc-&gt;nxGlobal != localLoc-&gt;nxGlobal</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;             || triggerLoc-&gt;nyGlobal != localLoc-&gt;nyGlobal</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;             || triggerLoc-&gt;nf != localLoc-&gt;nf) {</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;            <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;               Fatal(errorMessage);</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;               errorMessage.printf(</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                     <span class="stringliteral">&quot;%s: triggerResetLayer \&quot;%s\&quot; has incompatible dimensions.\n&quot;</span>,</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                     getDescription_c(),</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                     resetLayerName);</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;               errorMessage.printf(</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                     <span class="stringliteral">&quot;    \&quot;%s\&quot; is %d-by-%d-by-%d and \&quot;%s\&quot; is %d-by-%d-by-%d.\n&quot;</span>,</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                     name,</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                     localLoc-&gt;nxGlobal,</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                     localLoc-&gt;nyGlobal,</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                     localLoc-&gt;nf,</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                     resetLayerName,</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                     triggerLoc-&gt;nxGlobal,</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                     triggerLoc-&gt;nyGlobal,</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                     triggerLoc-&gt;nf);</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            }</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;         }</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;      }</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;   }</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;   <span class="comment">// Here, the connection tells all participating recev layers to allocate memory on gpu</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;   <span class="comment">// if receive from gpu is set. These buffers should be set in allocate</span></div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;   <span class="keywordflow">if</span> (mUpdateGpu) {</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;      this-&gt;setAllocDeviceGSyn();</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;      this-&gt;setAllocDeviceV();</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;      this-&gt;setAllocDeviceActivity();</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;   }</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;}</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;Response::Status HyPerLayer::setMaxPhase(<span class="keywordtype">int</span> *maxPhase) {</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;   <span class="keywordflow">if</span> (*maxPhase &lt; phase) {</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;      *maxPhase = phase;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;   }</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;}</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a5e0693ed1e7c21c88180e40a79613acb"> 1235</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a5e0693ed1e7c21c88180e40a79613acb">HyPerLayer::addRecvConn</a>(<a class="code" href="classPV_1_1BaseConnection.html">BaseConnection</a> *conn) {</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;   FatalIf(</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;         conn-&gt;getPost() != <span class="keyword">this</span>,</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;         <span class="stringliteral">&quot;%s called addRecvConn for %s, but \&quot;%s\&quot; is not the post-synaptic layer for \&quot;%s\&quot;\n.&quot;</span>,</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;         conn-&gt;getDescription_c(),</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;         getDescription_c(),</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;         getName(),</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;         conn-&gt;getName());</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;   <span class="comment">// CPU connections must run first to avoid race conditions</span></div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;   <span class="keywordflow">if</span> (!conn-&gt;getReceiveGpu()) {</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;      recvConns.insert(recvConns.begin(), conn);</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;   }</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;   <span class="comment">// Otherwise, add to the back. If no gpus at all, just add to back</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;   {</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      recvConns.push_back(conn);</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;      <span class="comment">// If it is receiving from gpu, set layer flag as such</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;      mRecvGpu = <span class="keyword">true</span>;</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;   }</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;}</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;<span class="keywordtype">int</span> HyPerLayer::openOutputStateFile(<a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer) {</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;   pvAssert(writeStep &gt;= 0);</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;   <span class="keywordflow">if</span> (checkpointer-&gt;getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#a26777df69a9a3dbf8b084da315c1e86e">getRank</a>() == 0) {</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;      std::string outputStatePath(getName());</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      outputStatePath.append(<span class="stringliteral">&quot;.pvp&quot;</span>);</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;      std::string checkpointLabel(getName());</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;      checkpointLabel.append(<span class="stringliteral">&quot;_filepos&quot;</span>);</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;      <span class="keywordtype">bool</span> createFlag    = checkpointer-&gt;getCheckpointReadDirectory().empty();</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;      mOutputStateStream = <span class="keyword">new</span> <a class="code" href="classPV_1_1CheckpointableFileStream.html">CheckpointableFileStream</a>(</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;            outputStatePath.c_str(), createFlag, checkpointer, checkpointLabel);</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;   }</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;}</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="keywordtype">void</span> HyPerLayer::synchronizeMarginWidth(<a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> *layer) {</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;   <span class="keywordflow">if</span> (layer == <span class="keyword">this</span>) {</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;   }</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;   assert(layer-&gt;getLayerLoc() != NULL &amp;&amp; this-&gt;getLayerLoc() != NULL);</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;   <a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> **newSynchronizedMarginWidthLayers =</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;         (<a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> **)calloc(numSynchronizedMarginWidthLayers + 1, <span class="keyword">sizeof</span>(<a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> *));</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;   assert(newSynchronizedMarginWidthLayers);</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;   <span class="keywordflow">if</span> (numSynchronizedMarginWidthLayers &gt; 0) {</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; numSynchronizedMarginWidthLayers; k++) {</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;         newSynchronizedMarginWidthLayers[k] = synchronizedMarginWidthLayers[k];</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;      }</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;      free(synchronizedMarginWidthLayers);</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;   }</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;      assert(synchronizedMarginWidthLayers == NULL);</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;   }</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;   synchronizedMarginWidthLayers = newSynchronizedMarginWidthLayers;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;   synchronizedMarginWidthLayers[numSynchronizedMarginWidthLayers] = layer;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;   numSynchronizedMarginWidthLayers++;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;   equalizeMargins(<span class="keyword">this</span>, layer);</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;}</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="keywordtype">int</span> HyPerLayer::equalizeMargins(<a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> *layer1, <a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> *layer2) {</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;   <span class="keywordtype">int</span> border1, border2, maxborder, result;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;   <span class="keywordtype">int</span> status = PV_SUCCESS;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;   border1   = layer1-&gt;getLayerLoc()-&gt;halo.lt;</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;   border2   = layer2-&gt;getLayerLoc()-&gt;halo.lt;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;   maxborder = border1 &gt; border2 ? border1 : border2;</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;   layer1-&gt;requireMarginWidth(maxborder, &amp;result, <span class="charliteral">&#39;x&#39;</span>);</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;   <span class="keywordflow">if</span> (result != maxborder) {</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;   }</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;   layer2-&gt;requireMarginWidth(maxborder, &amp;result, <span class="charliteral">&#39;x&#39;</span>);</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;   <span class="keywordflow">if</span> (result != maxborder) {</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;   }</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;   <span class="keywordflow">if</span> (status != PV_SUCCESS) {</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;      Fatal().printf(</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;            <span class="stringliteral">&quot;Error in rank %d process: unable to synchronize x-margin widths of layers \&quot;%s\&quot; and &quot;</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;            <span class="stringliteral">&quot;\&quot;%s\&quot; to %d\n&quot;</span>,</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;            layer1-&gt;parent-&gt;columnId(),</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;            layer1-&gt;getName(),</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;            layer2-&gt;getName(),</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;            maxborder);</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;      ;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;   }</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;   assert(</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;         layer1-&gt;getLayerLoc()-&gt;halo.lt == layer2-&gt;getLayerLoc()-&gt;halo.lt</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;         &amp;&amp; layer1-&gt;getLayerLoc()-&gt;halo.rt == layer2-&gt;getLayerLoc()-&gt;halo.rt</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;         &amp;&amp; layer1-&gt;getLayerLoc()-&gt;halo.lt == layer1-&gt;getLayerLoc()-&gt;halo.rt</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;         &amp;&amp; layer1-&gt;getLayerLoc()-&gt;halo.lt == maxborder);</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;   border1   = layer1-&gt;getLayerLoc()-&gt;halo.dn;</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;   border2   = layer2-&gt;getLayerLoc()-&gt;halo.dn;</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;   maxborder = border1 &gt; border2 ? border1 : border2;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;   layer1-&gt;requireMarginWidth(maxborder, &amp;result, <span class="charliteral">&#39;y&#39;</span>);</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;   <span class="keywordflow">if</span> (result != maxborder) {</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;   }</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;   layer2-&gt;requireMarginWidth(maxborder, &amp;result, <span class="charliteral">&#39;y&#39;</span>);</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;   <span class="keywordflow">if</span> (result != maxborder) {</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;      status = PV_FAILURE;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;   }</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;   <span class="keywordflow">if</span> (status != PV_SUCCESS) {</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;      Fatal().printf(</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;            <span class="stringliteral">&quot;Error in rank %d process: unable to synchronize y-margin widths of layers \&quot;%s\&quot; and &quot;</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;            <span class="stringliteral">&quot;\&quot;%s\&quot; to %d\n&quot;</span>,</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;            layer1-&gt;parent-&gt;columnId(),</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;            layer1-&gt;getName(),</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;            layer2-&gt;getName(),</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;            maxborder);</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;      ;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;   }</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;   assert(</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;         layer1-&gt;getLayerLoc()-&gt;halo.dn == layer2-&gt;getLayerLoc()-&gt;halo.dn</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;         &amp;&amp; layer1-&gt;getLayerLoc()-&gt;halo.up == layer2-&gt;getLayerLoc()-&gt;halo.up</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;         &amp;&amp; layer1-&gt;getLayerLoc()-&gt;halo.dn == layer1-&gt;getLayerLoc()-&gt;halo.up</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;         &amp;&amp; layer1-&gt;getLayerLoc()-&gt;halo.dn == maxborder);</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;}</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;Response::Status HyPerLayer::allocateDataStructures() {</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;   <span class="comment">// Once initialize and communicateInitInfo have been called, HyPerLayer has the</span></div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;   <span class="comment">// information it needs to allocate the membrane potential buffer V, the</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;   <span class="comment">// activity buffer activity-&gt;data, and the data store.</span></div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;   <span class="keyword">auto</span> status = Response::SUCCESS;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;   <span class="comment">// Doing this check here, since trigger layers are being set up in communicateInitInfo</span></div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;   <span class="comment">// If the magnitude of the trigger offset is bigger than the delta update time, then error</span></div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;   <span class="keywordflow">if</span> (triggerFlag) {</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;      <span class="keywordtype">double</span> deltaUpdateTime = <a class="code" href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664">getDeltaUpdateTime</a>();</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;      <span class="keywordflow">if</span> (deltaUpdateTime != -1 &amp;&amp; triggerOffset &gt;= deltaUpdateTime) {</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;         Fatal().printf(</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;               <span class="stringliteral">&quot;%s error in rank %d process: TriggerOffset (%f) must be lower than the change in &quot;</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;               <span class="stringliteral">&quot;update time (%f) \n&quot;</span>,</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;               getDescription_c(),</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;               parent-&gt;columnId(),</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;               triggerOffset,</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;               deltaUpdateTime);</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;      }</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;   }</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;   allocateClayerBuffers();</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;   <span class="keyword">const</span> <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> *loc = getLayerLoc();</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;   <span class="keywordtype">int</span> nx                = loc-&gt;nx;</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;   <span class="keywordtype">int</span> ny                = loc-&gt;ny;</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;   <span class="keywordtype">int</span> nf                = loc-&gt;nf;</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;   <a class="code" href="structPVHalo__.html">PVHalo</a> <span class="keyword">const</span> *halo    = &amp;loc-&gt;halo;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;   <span class="comment">// If not mirroring, fill the boundaries with the value in the valueBC param</span></div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;   <span class="keywordflow">if</span> (!useMirrorBCs() &amp;&amp; getValueBC() != 0.0f) {</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;      <span class="keywordtype">int</span> idx = 0;</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> batch = 0; batch &lt; loc-&gt;nbatch; batch++) {</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; halo-&gt;up; b++) {</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; (nx + halo-&gt;lt + halo-&gt;rt) * nf; k++) {</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;               clayer-&gt;activity-&gt;data[idx] = getValueBC();</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;               idx++;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;            }</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;         }</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; ny; y++) {</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; halo-&gt;lt * nf; k++) {</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;               clayer-&gt;activity-&gt;data[idx] = getValueBC();</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;               idx++;</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;            }</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;            idx += nx * nf;</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; halo-&gt;rt * nf; k++) {</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;               clayer-&gt;activity-&gt;data[idx] = getValueBC();</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;               idx++;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;            }</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;         }</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; halo-&gt;dn; b++) {</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; (nx + halo-&gt;lt + halo-&gt;rt) * nf; k++) {</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;               clayer-&gt;activity-&gt;data[idx] = getValueBC();</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;               idx++;</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;            }</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;         }</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;      }</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;      assert(idx == getNumExtendedAllBatches());</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;   }</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;   <span class="comment">// allocate storage for the input conductance arrays</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;   allocateBuffers();</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;   <span class="comment">// Allocate temp buffers if needed, 1 for each thread</span></div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;   <span class="keywordflow">if</span> (parent-&gt;getNumThreads() &gt; 1) {</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;      thread_gSyn = (<span class="keywordtype">float</span> **)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span> *) * parent-&gt;getNumThreads());</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;      assert(thread_gSyn);</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;      <span class="comment">// Assign thread_gSyn to different points of tempMem</span></div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; parent-&gt;getNumThreads(); i++) {</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;         <span class="keywordtype">float</span> *tempMem = (<span class="keywordtype">float</span> *)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * getNumNeuronsAllBatches());</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;         <span class="keywordflow">if</span> (!tempMem) {</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;            Fatal().printf(</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;                  <span class="stringliteral">&quot;HyPerLayer \&quot;%s\&quot; error: rank %d unable to allocate %zu memory for thread_gSyn: &quot;</span></div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;                  <span class="stringliteral">&quot;%s\n&quot;</span>,</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                  name,</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                  parent-&gt;columnId(),</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;                  <span class="keyword">sizeof</span>(float) * getNumNeuronsAllBatches(),</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                  strerror(errno));</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;         }</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;         thread_gSyn[i] = tempMem;</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;      }</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;   }</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;<span class="comment">// Allocate cuda stuff on gpu if set</span></div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;   <span class="keywordtype">int</span> deviceStatus = <a class="code" href="classPV_1_1HyPerLayer.html#af6bf682a8b67348ca0cf200a9ba3a44b">allocateDeviceBuffers</a>();</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;   <span class="comment">// Allocate receive from post kernel</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;   <span class="keywordflow">if</span> (deviceStatus == 0) {</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;      status = Response::SUCCESS;</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;   }</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;      Fatal().printf(</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;            <span class="stringliteral">&quot;%s unable to allocate device memory in rank %d process: %s\n&quot;</span>,</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;            getDescription_c(),</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;            parent-&gt;columnId(),</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;            strerror(errno));</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;   }</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;   <span class="keywordflow">if</span> (mUpdateGpu) {</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;      <span class="comment">// This function needs to be overwritten as needed on a subclass basis</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;      deviceStatus = allocateUpdateKernel();</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;      <span class="keywordflow">if</span> (deviceStatus == 0) {</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;         status = Response::SUCCESS;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;      }</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;   }</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;   addPublisher();</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;}</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="comment"> * Call this routine to increase the number of levels in the data store ring buffer.</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="comment"> * Calls to this routine after the data store has been initialized will have no effect.</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="comment"> * The routine returns the new value of numDelayLevels</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="keywordtype">int</span> HyPerLayer::increaseDelayLevels(<span class="keywordtype">int</span> neededDelay) {</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;   <span class="keywordflow">if</span> (numDelayLevels &lt; neededDelay + 1)</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;      numDelayLevels = neededDelay + 1;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;   <span class="keywordflow">if</span> (numDelayLevels &gt; MAX_F_DELAY)</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;      numDelayLevels = MAX_F_DELAY;</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;   <span class="keywordflow">return</span> numDelayLevels;</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;}</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="keywordtype">int</span> HyPerLayer::requireMarginWidth(<span class="keywordtype">int</span> marginWidthNeeded, <span class="keywordtype">int</span> *marginWidthResult, <span class="keywordtype">char</span> axis) {</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;   <span class="comment">// TODO: Is there a good way to handle x- and y-axis margins without so much duplication of code?</span></div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;   <span class="comment">// Navigating through the halo makes it difficult to combine cases.</span></div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;   <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> *loc = &amp;clayer-&gt;loc;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;   <a class="code" href="structPVHalo__.html">PVHalo</a> *halo    = &amp;loc-&gt;halo;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;   <span class="keywordflow">switch</span> (axis) {</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>:</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;         *marginWidthResult = xmargin;</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;         <span class="keywordflow">if</span> (xmargin &lt; marginWidthNeeded) {</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;            assert(clayer);</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;            <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;               InfoLog().printf(</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                     <span class="stringliteral">&quot;%s: adjusting x-margin width from %d to %d\n&quot;</span>,</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;                     getDescription_c(),</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                     xmargin,</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                     marginWidthNeeded);</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;            }</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;            xmargin  = marginWidthNeeded;</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;            halo-&gt;lt = xmargin;</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;            halo-&gt;rt = xmargin;</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;            calcNumExtended();</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;            assert(axis == <span class="charliteral">&#39;x&#39;</span> &amp;&amp; getLayerLoc()-&gt;halo.lt == getLayerLoc()-&gt;halo.rt);</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;            *marginWidthResult = xmargin;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;            <span class="keywordflow">if</span> (synchronizedMarginWidthLayers != NULL) {</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; numSynchronizedMarginWidthLayers; k++) {</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                  <a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> *l = synchronizedMarginWidthLayers[k];</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                  <span class="keywordflow">if</span> (l-&gt;getLayerLoc()-&gt;halo.lt &lt; marginWidthNeeded) {</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                     synchronizedMarginWidthLayers[k]-&gt;requireMarginWidth(</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                           marginWidthNeeded, marginWidthResult, axis);</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;                  }</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                  assert(l-&gt;getLayerLoc()-&gt;halo.lt == getLayerLoc()-&gt;halo.lt);</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                  assert(l-&gt;getLayerLoc()-&gt;halo.rt == getLayerLoc()-&gt;halo.rt);</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;               }</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;            }</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;         }</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;      <span class="keywordflow">case</span> <span class="charliteral">&#39;y&#39;</span>:</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;         *marginWidthResult = ymargin;</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;         <span class="keywordflow">if</span> (ymargin &lt; marginWidthNeeded) {</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;            assert(clayer);</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;            <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;               InfoLog().printf(</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;                     <span class="stringliteral">&quot;%s: adjusting y-margin width from %d to %d\n&quot;</span>,</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;                     getDescription_c(),</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;                     ymargin,</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;                     marginWidthNeeded);</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;            }</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;            ymargin  = marginWidthNeeded;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;            halo-&gt;dn = ymargin;</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;            halo-&gt;up = ymargin;</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;            calcNumExtended();</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;            assert(axis == <span class="charliteral">&#39;y&#39;</span> &amp;&amp; getLayerLoc()-&gt;halo.dn == getLayerLoc()-&gt;halo.up);</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;            *marginWidthResult = ymargin;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;            <span class="keywordflow">if</span> (synchronizedMarginWidthLayers != NULL) {</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; numSynchronizedMarginWidthLayers; k++) {</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;                  <a class="code" href="classPV_1_1HyPerLayer.html">HyPerLayer</a> *l = synchronizedMarginWidthLayers[k];</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;                  <span class="keywordflow">if</span> (l-&gt;getLayerLoc()-&gt;halo.up &lt; marginWidthNeeded) {</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;                     synchronizedMarginWidthLayers[k]-&gt;requireMarginWidth(</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                           marginWidthNeeded, marginWidthResult, axis);</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;                  }</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;                  assert(l-&gt;getLayerLoc()-&gt;halo.dn == getLayerLoc()-&gt;halo.dn);</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;                  assert(l-&gt;getLayerLoc()-&gt;halo.up == getLayerLoc()-&gt;halo.up);</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;               }</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;            }</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;         }</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;         <span class="keywordflow">break</span>;</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;      <span class="keywordflow">default</span>: assert(0); <span class="keywordflow">break</span>;</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;   }</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;}</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;<span class="keywordtype">int</span> HyPerLayer::requireChannel(<span class="keywordtype">int</span> channelNeeded, <span class="keywordtype">int</span> *numChannelsResult) {</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;   <span class="keywordflow">if</span> (channelNeeded &gt;= numChannels) {</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;      <span class="keywordtype">int</span> numOldChannels = numChannels;</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;      numChannels        = channelNeeded + 1;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;   }</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;   *numChannelsResult = numChannels;</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;}</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;</div><div class="line"><a name="l01573"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a09e35d33646f5a6dc1e0a81e75de1839"> 1573</a></span>&#160;<span class="keyword">const</span> <span class="keywordtype">float</span> *<a class="code" href="classPV_1_1HyPerLayer.html#a09e35d33646f5a6dc1e0a81e75de1839">HyPerLayer::getLayerData</a>(<span class="keywordtype">int</span> delay) {</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;   <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> cube = publisher-&gt;<a class="code" href="classPV_1_1Publisher.html#a774cd7c66353e2ecc113048ba3754e19">createCube</a>(delay);</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;   <span class="keywordflow">return</span> cube.data;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;}</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorInteriorToBorder(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *cube, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *border) {</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;   assert(cube-&gt;numItems == border-&gt;numItems);</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;   assert(localDimensionsEqual(&amp;cube-&gt;loc, &amp;border-&gt;loc));</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;   mirrorToNorthWest(border, cube);</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;   mirrorToNorth(border, cube);</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;   mirrorToNorthEast(border, cube);</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;   mirrorToWest(border, cube);</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;   mirrorToEast(border, cube);</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;   mirrorToSouthWest(border, cube);</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;   mirrorToSouth(border, cube);</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;   mirrorToSouthEast(border, cube);</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;}</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;Response::Status HyPerLayer::registerData(<a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer) {</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;   <span class="keyword">auto</span> status = BaseLayer::registerData(checkpointer);</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;   <span class="keywordflow">if</span> (!<a class="code" href="namespacePV_1_1Response.html#aa3623495ae9596716973fbe1f4e76bab">Response::completed</a>(status)) {</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;      <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;   }</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;   checkpointPvpActivityFloat(checkpointer, <span class="stringliteral">&quot;A&quot;</span>, getActivity(), <span class="keyword">true</span> <span class="comment">/*extended*/</span>);</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;   <span class="keywordflow">if</span> (getV() != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;      checkpointPvpActivityFloat(checkpointer, <span class="stringliteral">&quot;V&quot;</span>, getV(), <span class="keyword">false</span> <span class="comment">/*not extended*/</span>);</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;   }</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;   publisher-&gt;checkpointDataStore(checkpointer, getName(), <span class="stringliteral">&quot;Delays&quot;</span>);</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;   checkpointer-&gt;registerCheckpointData(</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;         std::string(getName()),</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;         std::string(<span class="stringliteral">&quot;lastUpdateTime&quot;</span>),</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;         &amp;mLastUpdateTime,</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;         (std::size_t)1,</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;         <span class="keyword">true</span> <span class="comment">/*broadcast*/</span>,</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;         <span class="keyword">false</span> <span class="comment">/*not constant*/</span>);</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;   checkpointer-&gt;registerCheckpointData(</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;         std::string(getName()),</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;         std::string(<span class="stringliteral">&quot;nextWrite&quot;</span>),</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;         &amp;writeTime,</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;         (std::size_t)1,</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;         <span class="keyword">true</span> <span class="comment">/*broadcast*/</span>,</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;         <span class="keyword">false</span> <span class="comment">/*not constant*/</span>);</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;   <span class="keywordflow">if</span> (writeStep &gt;= 0.0) {</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;      openOutputStateFile(checkpointer);</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;      <span class="keywordflow">if</span> (sparseLayer) {</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;         checkpointer-&gt;registerCheckpointData(</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;               std::string(getName()),</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;               std::string(<span class="stringliteral">&quot;numframes_sparse&quot;</span>),</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;               &amp;writeActivitySparseCalls,</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;               (std::size_t)1,</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;               <span class="keyword">true</span> <span class="comment">/*broadcast*/</span>,</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;               <span class="keyword">false</span> <span class="comment">/*not constant*/</span>);</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;      }</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;         checkpointer-&gt;registerCheckpointData(</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;               std::string(getName()),</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;               std::string(<span class="stringliteral">&quot;numframes&quot;</span>),</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;               &amp;writeActivityCalls,</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;               (std::size_t)1,</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;               <span class="keyword">true</span> <span class="comment">/*broadcast*/</span>,</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;               <span class="keyword">false</span> <span class="comment">/*not constant*/</span>);</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;      }</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;   }</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;   <span class="comment">// Timers</span></div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;   update_timer = <span class="keyword">new</span> <a class="code" href="classPV_1_1Timer.html">Timer</a>(getName(), <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;update &quot;</span>);</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;   checkpointer-&gt;registerTimer(update_timer);</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;   recvsyn_timer = <span class="keyword">new</span> <a class="code" href="classPV_1_1Timer.html">Timer</a>(getName(), <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;recvsyn&quot;</span>);</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;   checkpointer-&gt;registerTimer(recvsyn_timer);</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;   <span class="keyword">auto</span> cudaDevice = parent-&gt;getDevice();</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;   <span class="keywordflow">if</span> (cudaDevice) {</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;      gpu_update_timer = <span class="keyword">new</span> PVCuda::CudaTimer(getName(), <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;gpuupdate&quot;</span>);</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;      gpu_update_timer-&gt;setStream(cudaDevice-&gt;getStream());</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;      checkpointer-&gt;registerTimer(gpu_update_timer);</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;      gpu_recvsyn_timer = <span class="keyword">new</span> PVCuda::CudaTimer(getName(), <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;gpurecvsyn&quot;</span>);</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;      gpu_recvsyn_timer-&gt;setStream(cudaDevice-&gt;getStream());</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;      checkpointer-&gt;registerTimer(gpu_recvsyn_timer);</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;   }</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="preprocessor">#endif // PV_USE_CUDA</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;   publish_timer = <span class="keyword">new</span> <a class="code" href="classPV_1_1Timer.html">Timer</a>(getName(), <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;publish&quot;</span>);</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;   checkpointer-&gt;registerTimer(publish_timer);</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;   timescale_timer = <span class="keyword">new</span> <a class="code" href="classPV_1_1Timer.html">Timer</a>(getName(), <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;timescale&quot;</span>);</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;   checkpointer-&gt;registerTimer(timescale_timer);</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;   io_timer = <span class="keyword">new</span> <a class="code" href="classPV_1_1Timer.html">Timer</a>(getName(), <span class="stringliteral">&quot;layer&quot;</span>, <span class="stringliteral">&quot;io     &quot;</span>);</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;   checkpointer-&gt;registerTimer(io_timer);</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;   <span class="keywordflow">if</span> (mInitVObject) {</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;      <span class="keyword">auto</span> message = std::make_shared&lt;RegisterDataMessage&lt;Checkpointer&gt;&gt;(checkpointer);</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;      mInitVObject-&gt;respond(message);</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;   }</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;}</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;</div><div class="line"><a name="l01677"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664"> 1677</a></span>&#160;<span class="keywordtype">double</span> <a class="code" href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664">HyPerLayer::getDeltaUpdateTime</a>() {</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;   <span class="keywordflow">if</span> (triggerLayer != NULL &amp;&amp; triggerBehaviorType == UPDATEONLY_TRIGGER) {</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="classPV_1_1HyPerLayer.html#ab0088a3129cf584f2df0b50002bb88ac">getDeltaTriggerTime</a>();</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;   }</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;      <span class="keywordflow">return</span> parent-&gt;getDeltaTime();</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;   }</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;}</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;</div><div class="line"><a name="l01686"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#ab0088a3129cf584f2df0b50002bb88ac"> 1686</a></span>&#160;<span class="keywordtype">double</span> <a class="code" href="classPV_1_1HyPerLayer.html#ab0088a3129cf584f2df0b50002bb88ac">HyPerLayer::getDeltaTriggerTime</a>() {</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;   <span class="keywordflow">if</span> (triggerLayer != NULL) {</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;      <span class="keywordflow">return</span> triggerLayer-&gt;<a class="code" href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664">getDeltaUpdateTime</a>();</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;   }</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;   }</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;}</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;</div><div class="line"><a name="l01695"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a8a8f1f11808763cf05727f5e15f595a8"> 1695</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classPV_1_1HyPerLayer.html#a8a8f1f11808763cf05727f5e15f595a8">HyPerLayer::needUpdate</a>(<span class="keywordtype">double</span> simTime, <span class="keywordtype">double</span> dt) {</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664">getDeltaUpdateTime</a>() &lt;= 0) {</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;   }</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;   <span class="keywordflow">if</span> (mLastUpdateTime == simTime + triggerOffset) {</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;   }</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;   <span class="keywordtype">double</span> timeToCheck = mLastUpdateTime;</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;   <span class="keywordflow">if</span> (triggerLayer != <span class="keyword">nullptr</span> &amp;&amp; triggerBehaviorType == UPDATEONLY_TRIGGER) {</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;      timeToCheck = triggerLayer-&gt;getLastUpdateTime();</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;      <span class="comment">// If our target layer updates this tick, so do we</span></div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;      <span class="keywordflow">if</span> (timeToCheck == simTime &amp;&amp; triggerOffset == 0) {</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;         <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;      }</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;   }</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;   <span class="keywordflow">if</span> (simTime + triggerOffset &gt;= timeToCheck + <a class="code" href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664">getDeltaUpdateTime</a>()</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;       &amp;&amp; simTime + triggerOffset + dt &lt;= timeToCheck + <a class="code" href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664">getDeltaUpdateTime</a>() + dt) {</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;   }</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;   <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;}</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;</div><div class="line"><a name="l01718"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a07cb415a70aedf6cc8fc57e493d17139"> 1718</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classPV_1_1HyPerLayer.html#a07cb415a70aedf6cc8fc57e493d17139">HyPerLayer::needReset</a>(<span class="keywordtype">double</span> simTime, <span class="keywordtype">double</span> dt) {</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;   <span class="keywordflow">if</span> (triggerLayer == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;   }</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;   <span class="keywordflow">if</span> (triggerBehaviorType != RESETSTATE_TRIGGER) {</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;   }</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="classPV_1_1HyPerLayer.html#ab0088a3129cf584f2df0b50002bb88ac">getDeltaTriggerTime</a>() &lt;= 0) {</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;   }</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;   <span class="keywordflow">if</span> (simTime &gt;= mLastTriggerTime + <a class="code" href="classPV_1_1HyPerLayer.html#ab0088a3129cf584f2df0b50002bb88ac">getDeltaTriggerTime</a>()) {</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;      <span class="comment">// TODO: test &quot;simTime &gt; mLastTriggerTime + getDeltaTriggerTime() - 0.5 * dt&quot;,</span></div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;      <span class="comment">// to avoid roundoff issues.</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;   }</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;   <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;}</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;Response::Status HyPerLayer::callUpdateState(<span class="keywordtype">double</span> simTime, <span class="keywordtype">double</span> dt) {</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;   <span class="keyword">auto</span> status = Response::NO_ACTION;</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="classPV_1_1HyPerLayer.html#a8a8f1f11808763cf05727f5e15f595a8">needUpdate</a>(simTime, dt)) {</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classPV_1_1HyPerLayer.html#a07cb415a70aedf6cc8fc57e493d17139">needReset</a>(simTime, dt)) {</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;         <a class="code" href="classPV_1_1HyPerLayer.html#a06eb20101adacc02c0963e981816dfa2">resetStateOnTrigger</a>();</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;         mLastTriggerTime = simTime;</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;      }</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;      update_timer-&gt;start();</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;      <span class="keywordflow">if</span> (mUpdateGpu) {</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;         gpu_update_timer-&gt;start();</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;         <span class="keywordtype">float</span> *gSynHead = GSyn == NULL ? NULL : GSyn[0];</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;         assert(mUpdateGpu);</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;         status = updateStateGpu(simTime, dt);</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;         gpu_update_timer-&gt;stop();</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;      }</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;         status = updateState(simTime, dt);</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;      }</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;      <span class="comment">// Activity updated, set flag to true</span></div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;      updatedDeviceActivity  = <span class="keyword">true</span>;</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;      updatedDeviceDatastore = <span class="keyword">true</span>;</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;      update_timer-&gt;stop();</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;      mNeedToPublish  = <span class="keyword">true</span>;</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;      mLastUpdateTime = simTime;</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;   }</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;}</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;</div><div class="line"><a name="l01769"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a06eb20101adacc02c0963e981816dfa2"> 1769</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classPV_1_1HyPerLayer.html#a06eb20101adacc02c0963e981816dfa2">HyPerLayer::resetStateOnTrigger</a>() {</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;   assert(triggerResetLayer != NULL);</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;   <span class="keywordtype">float</span> *V = getV();</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;   <span class="keywordflow">if</span> (V == NULL) {</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;      <span class="keywordflow">if</span> (parent-&gt;columnId() == 0) {</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;         ErrorLog().printf(</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;               <span class="stringliteral">&quot;%s: triggerBehavior is \&quot;resetStateOnTrigger\&quot; but layer does not have a membrane &quot;</span></div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;               <span class="stringliteral">&quot;potential.\n&quot;</span>,</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;               getDescription_c());</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;      }</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;      MPI_Barrier(parent-&gt;getCommunicator()-&gt;communicator());</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;      exit(EXIT_FAILURE);</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;   }</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;   <span class="keywordtype">float</span> <span class="keyword">const</span> *resetV = triggerResetLayer-&gt;getV();</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;   <span class="keywordflow">if</span> (resetV != NULL) {</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="preprocessor">#ifdef PV_USE_OPENMP_THREADS</span></div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="preprocessor">#pragma omp parallel for</span></div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="preprocessor">#endif // PV_USE_OPENMP_THREADS</span></div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; getNumNeuronsAllBatches(); k++) {</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;         V[k] = resetV[k];</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;      }</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;   }</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;      <span class="keywordtype">float</span> <span class="keyword">const</span> *resetA   = triggerResetLayer-&gt;getActivity();</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;      <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *loc = triggerResetLayer-&gt;getLayerLoc();</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;      <a class="code" href="structPVHalo__.html">PVHalo</a> <span class="keyword">const</span> *halo    = &amp;loc-&gt;halo;</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; parent-&gt;getNBatch(); b++) {</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;         <span class="keywordtype">float</span> <span class="keyword">const</span> *resetABatch = resetA + (b * triggerResetLayer-&gt;getNumExtended());</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;         <span class="keywordtype">float</span> *VBatch            = V + (b * triggerResetLayer-&gt;getNumNeurons());</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;<span class="preprocessor">#ifdef PV_USE_OPENMP_THREADS</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="preprocessor">#pragma omp parallel for</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="preprocessor">#endif // PV_USE_OPENMP_THREADS</span></div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; getNumNeurons(); k++) {</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;            <span class="keywordtype">int</span> kex = kIndexExtended(</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;                  k, loc-&gt;nx, loc-&gt;ny, loc-&gt;nf, halo-&gt;lt, halo-&gt;rt, halo-&gt;dn, halo-&gt;up);</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;            VBatch[k] = resetABatch[kex];</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;         }</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;      }</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;   }</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;   setActivity();</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="comment">// Update V on GPU after CPU V gets set</span></div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;   <span class="keywordflow">if</span> (mUpdateGpu) {</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;      getDeviceV()-&gt;copyToDevice(V);</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;      <span class="comment">// Right now, we&#39;re setting the activity on the CPU and memsetting the GPU memory</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;      <span class="comment">// TODO calculate this on the GPU</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;      getDeviceActivity()-&gt;copyToDevice(clayer-&gt;activity-&gt;data);</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;      <span class="comment">// We need to updateDeviceActivity and Datastore if we&#39;re resetting V</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;      updatedDeviceActivity  = <span class="keyword">true</span>;</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;      updatedDeviceDatastore = <span class="keyword">true</span>;</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;   }</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;}</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="keywordtype">int</span> HyPerLayer::resetGSynBuffers(<span class="keywordtype">double</span> timef, <span class="keywordtype">double</span> dt) {</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;   <span class="keywordtype">int</span> status = PV_SUCCESS;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;   <span class="keywordflow">if</span> (GSyn == NULL)</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;      <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;   resetGSynBuffers_HyPerLayer(</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;         parent-&gt;getNBatch(), this-&gt;getNumNeurons(), getNumChannels(), GSyn[0]);</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;}</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="keywordtype">int</span> HyPerLayer::runUpdateKernel() {</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;   assert(mUpdateGpu);</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;   <span class="keywordflow">if</span> (updatedDeviceGSyn) {</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;      copyAllGSynToDevice();</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;      updatedDeviceGSyn = <span class="keyword">false</span>;</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;   }</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;   <span class="comment">// V and Activity are write only buffers, so we don&#39;t need to do anything with them</span></div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;   assert(krUpdate);</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;   <span class="comment">// Sync all buffers before running</span></div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;   syncGpu();</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;   <span class="comment">// Run kernel</span></div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;   krUpdate-&gt;run();</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;}</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;Response::Status HyPerLayer::updateStateGpu(<span class="keywordtype">double</span> timef, <span class="keywordtype">double</span> dt) {</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;   Fatal() &lt;&lt; <span class="stringliteral">&quot;Update state for layer &quot;</span> &lt;&lt; name &lt;&lt; <span class="stringliteral">&quot; is not implemented\n&quot;</span>;</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;   <span class="keywordflow">return</span> Response::NO_ACTION; <span class="comment">// never reached; added to prevent compiler warnings.</span></div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;}</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;Response::Status HyPerLayer::updateState(<span class="keywordtype">double</span> timef, <span class="keywordtype">double</span> dt) {</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;   <span class="comment">// just copy accumulation buffer to membrane potential</span></div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;   <span class="comment">// and activity buffer (nonspiking)</span></div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;   <span class="keyword">const</span> <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> *loc = getLayerLoc();</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;   <span class="keywordtype">float</span> *A              = getCLayer()-&gt;activity-&gt;data;</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;   <span class="keywordtype">float</span> *V              = getV();</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;   <span class="keywordtype">int</span> num_channels      = getNumChannels();</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;   <span class="keywordtype">float</span> *gSynHead       = GSyn == NULL ? NULL : GSyn[0];</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;   <span class="keywordtype">int</span> nx          = loc-&gt;nx;</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;   <span class="keywordtype">int</span> ny          = loc-&gt;ny;</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;   <span class="keywordtype">int</span> nf          = loc-&gt;nf;</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;   <span class="keywordtype">int</span> nbatch      = loc-&gt;nbatch;</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;   <span class="keywordtype">int</span> num_neurons = nx * ny * nf;</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;   <span class="keywordflow">if</span> (num_channels == 1) {</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;      applyGSyn_HyPerLayer1Channel(nbatch, num_neurons, V, gSynHead);</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;   }</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;      applyGSyn_HyPerLayer(nbatch, num_neurons, V, gSynHead);</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;   }</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;   setActivity_HyPerLayer(</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;         nbatch,</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;         num_neurons,</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;         A,</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;         V,</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;         nx,</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;         ny,</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;         nf,</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;         loc-&gt;halo.lt,</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;         loc-&gt;halo.rt,</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;         loc-&gt;halo.dn,</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;         loc-&gt;halo.up);</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;}</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="keywordtype">int</span> HyPerLayer::setActivity() {</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;   <span class="keyword">const</span> <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> *loc = getLayerLoc();</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;   <span class="keywordflow">return</span> setActivity_HyPerLayer(</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;         loc-&gt;nbatch,</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;         getNumNeurons(),</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;         clayer-&gt;activity-&gt;data,</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;         getV(),</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;         loc-&gt;nx,</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;         loc-&gt;ny,</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;         loc-&gt;nf,</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;         loc-&gt;halo.lt,</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;         loc-&gt;halo.rt,</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;         loc-&gt;halo.dn,</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;         loc-&gt;halo.up);</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;}</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;<span class="comment">// Updates active indices for all levels (delays) here</span></div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;<span class="keywordtype">void</span> HyPerLayer::updateAllActiveIndices() { publisher-&gt;updateAllActiveIndices(); }</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;<span class="keywordtype">void</span> HyPerLayer::updateActiveIndices() { publisher-&gt;updateActiveIndices(0); }</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;</div><div class="line"><a name="l01921"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a4bc274528390800826b2e9fdbbf19313"> 1921</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classPV_1_1HyPerLayer.html#a4bc274528390800826b2e9fdbbf19313">HyPerLayer::isExchangeFinished</a>(<span class="keywordtype">int</span> delay) { <span class="keywordflow">return</span> publisher-&gt;isExchangeFinished(delay); }</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;</div><div class="line"><a name="l01923"></a><span class="lineno"><a class="line" href="classPV_1_1HyPerLayer.html#a2e384c9ee929aef35ba67c526ff78fd2"> 1923</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classPV_1_1HyPerLayer.html#a2e384c9ee929aef35ba67c526ff78fd2">HyPerLayer::isAllInputReady</a>() {</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;   <span class="keywordtype">bool</span> isReady = <span class="keyword">true</span>;</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;   <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;c : recvConns) {</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;      isReady &amp;= c-&gt;isAllInputReady();</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;   }</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;   <span class="keywordflow">return</span> isReady;</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;}</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;<span class="keywordtype">int</span> HyPerLayer::recvAllSynapticInput() {</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;   <span class="keywordtype">int</span> status = PV_SUCCESS;</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;   <span class="comment">// Only recvAllSynapticInput if we need an update</span></div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;   <span class="keywordflow">if</span> (<a class="code" href="classPV_1_1HyPerLayer.html#a8a8f1f11808763cf05727f5e15f595a8">needUpdate</a>(parent-&gt;simulationTime(), parent-&gt;getDeltaTime())) {</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;      <span class="keywordtype">bool</span> switchGpu = <span class="keyword">false</span>;</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;      <span class="comment">// Start CPU timer here</span></div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;      recvsyn_timer-&gt;start();</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;      <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;conn : recvConns) {</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;         pvAssert(conn != NULL);</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;         <span class="comment">// Check if it&#39;s done with cpu connections</span></div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;         <span class="keywordflow">if</span> (!switchGpu &amp;&amp; conn-&gt;getReceiveGpu()) {</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;            <span class="comment">// Copy GSyn over to GPU</span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;            copyAllGSynToDevice();</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;            <span class="comment">// Start gpu timer</span></div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;            gpu_recvsyn_timer-&gt;start();</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;            switchGpu = <span class="keyword">true</span>;</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;         }</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;         conn-&gt;deliver();</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;      }</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;      <span class="keywordflow">if</span> (switchGpu) {</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;         <span class="comment">// Stop timer</span></div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;         gpu_recvsyn_timer-&gt;stop();</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;      }</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;      recvsyn_timer-&gt;stop();</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;   }</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;}</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;<span class="preprocessor">#ifdef PV_USE_CUDA</span></div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;<span class="keywordtype">double</span> HyPerLayer::addGpuTimers() {</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;   <span class="keywordtype">double</span> simTime    = 0;</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;   <span class="keywordtype">bool</span> updateNeeded = <a class="code" href="classPV_1_1HyPerLayer.html#a8a8f1f11808763cf05727f5e15f595a8">needUpdate</a>(parent-&gt;simulationTime(), parent-&gt;getDeltaTime());</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;   <span class="keywordflow">if</span> (mRecvGpu &amp;&amp; updateNeeded) {</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;      simTime += gpu_recvsyn_timer-&gt;accumulateTime();</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;   }</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;   <span class="keywordflow">if</span> (mUpdateGpu &amp;&amp; updateNeeded) {</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;      simTime += gpu_update_timer-&gt;accumulateTime();</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;   }</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;   <span class="keywordflow">return</span> simTime;</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;}</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;<span class="keywordtype">void</span> HyPerLayer::syncGpu() {</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;   <span class="keywordflow">if</span> (mRecvGpu || mUpdateGpu) {</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;      parent-&gt;getDevice()-&gt;syncDevice();</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;   }</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;}</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;<span class="keywordtype">void</span> HyPerLayer::copyAllGSynToDevice() {</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;   <span class="keywordflow">if</span> (mRecvGpu || mUpdateGpu) {</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;      <span class="comment">// Copy it to device</span></div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;      <span class="keywordtype">float</span> *h_postGSyn              = GSyn[0];</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;      PVCuda::CudaBuffer *d_postGSyn = this-&gt;getDeviceGSyn();</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;      assert(d_postGSyn);</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;      d_postGSyn-&gt;copyToDevice(h_postGSyn);</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;   }</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;}</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;<span class="keywordtype">void</span> HyPerLayer::copyAllGSynFromDevice() {</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;   <span class="comment">// Only copy if recving</span></div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;   <span class="keywordflow">if</span> (mRecvGpu) {</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;      <span class="keywordtype">float</span> *h_postGSyn              = GSyn[0];</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;      PVCuda::CudaBuffer *d_postGSyn = this-&gt;getDeviceGSyn();</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;      assert(d_postGSyn);</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;      d_postGSyn-&gt;copyFromDevice(h_postGSyn);</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;   }</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;}</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;<span class="keywordtype">void</span> HyPerLayer::copyAllVFromDevice() {</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;   <span class="comment">// Only copy if updating</span></div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;   <span class="keywordflow">if</span> (mUpdateGpu) {</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;      <span class="comment">// Allocated as a big chunk, this should work</span></div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;      <span class="keywordtype">float</span> *h_V              = getV();</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;      PVCuda::CudaBuffer *d_V = this-&gt;getDeviceV();</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;      assert(d_V);</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;      d_V-&gt;copyFromDevice(h_V);</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;   }</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;}</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;<span class="keywordtype">void</span> HyPerLayer::copyAllActivityFromDevice() {</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;   <span class="comment">// Only copy if updating</span></div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;   <span class="keywordflow">if</span> (mUpdateGpu) {</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;      <span class="comment">// Allocated as a big chunk, this should work</span></div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;      <span class="keywordtype">float</span> *h_activity              = getCLayer()-&gt;activity-&gt;data;</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;      PVCuda::CudaBuffer *d_activity = this-&gt;getDeviceActivity();</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;      assert(d_activity);</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;      d_activity-&gt;copyFromDevice(h_activity);</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;   }</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;}</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;<span class="keywordtype">int</span> HyPerLayer::publish(<a class="code" href="classPV_1_1Communicator.html">Communicator</a> *comm, <span class="keywordtype">double</span> simTime) {</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;   publish_timer-&gt;start();</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;   <span class="keywordtype">int</span> status = PV_SUCCESS;</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;   <span class="keywordflow">if</span> (mNeedToPublish) {</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;      <span class="keywordflow">if</span> (useMirrorBCs()) {</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;         mirrorInteriorToBorder(clayer-&gt;activity, clayer-&gt;activity);</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;      }</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;      status         = publisher-&gt;<a class="code" href="classPV_1_1Publisher.html#ab17ca30ec01a0d71b7775430b6ab7299">publish</a>(mLastUpdateTime);</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;      mNeedToPublish = <span class="keyword">false</span>;</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;   }</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;      publisher-&gt;<a class="code" href="classPV_1_1Publisher.html#a7112570f86ba629846478f70baa75738">copyForward</a>(mLastUpdateTime);</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;   }</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;   publish_timer-&gt;stop();</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;}</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;<span class="keywordtype">int</span> HyPerLayer::waitOnPublish(<a class="code" href="classPV_1_1Communicator.html">Communicator</a> *comm) {</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;   publish_timer-&gt;start();</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;   <span class="comment">// wait for MPI border transfers to complete</span></div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;   <span class="comment">//</span></div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;   <span class="keywordtype">int</span> status = publisher-&gt;<a class="code" href="classPV_1_1Publisher.html#a30fdc583f793a95583d3a06789bebb96">wait</a>();</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;   publish_timer-&gt;stop();</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;   <span class="keywordflow">return</span> status;</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;}</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;<span class="comment">/******************************************************************</span></div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;<span class="comment"> * FileIO</span></div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;<span class="comment"> *****************************************************************/</span></div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;<span class="comment">/* Inserts a new probe into an array of LayerProbes.</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;<span class="keywordtype">int</span> HyPerLayer::insertProbe(<a class="code" href="classPV_1_1LayerProbe.html">LayerProbe</a> *p) {</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;   <span class="keywordflow">if</span> (p-&gt;getTargetLayer() != <span class="keyword">this</span>) {</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;      WarnLog().printf(</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;            <span class="stringliteral">&quot;HyPerLayer \&quot;%s\&quot;: insertProbe called with probe %p, whose targetLayer is not this &quot;</span></div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;            <span class="stringliteral">&quot;layer.  Probe was not inserted.\n&quot;</span>,</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;            name,</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;            p);</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;      <span class="keywordflow">return</span> numProbes;</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;   }</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numProbes; i++) {</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;      <span class="keywordflow">if</span> (p == probes[i]) {</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;         WarnLog().printf(</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;               <span class="stringliteral">&quot;HyPerLayer \&quot;%s\&quot;: insertProbe called with probe %p, which has already been &quot;</span></div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;               <span class="stringliteral">&quot;inserted as probe %d.\n&quot;</span>,</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;               name,</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;               p,</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;               i);</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;         <span class="keywordflow">return</span> numProbes;</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;      }</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;   }</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;   <span class="comment">// malloc&#39;ing a new buffer, copying data over, and freeing the old buffer could be replaced by</span></div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;   <span class="comment">// malloc</span></div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;   <a class="code" href="classPV_1_1LayerProbe.html">LayerProbe</a> **tmp;</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;   tmp = (<a class="code" href="classPV_1_1LayerProbe.html">LayerProbe</a> **)malloc((numProbes + 1) * <span class="keyword">sizeof</span>(<a class="code" href="classPV_1_1LayerProbe.html">LayerProbe</a> *));</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;   assert(tmp != NULL);</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numProbes; i++) {</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;      tmp[i] = probes[i];</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;   }</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;   free(probes);</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;   probes            = tmp;</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;   probes[numProbes] = p;</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;   <span class="keywordflow">return</span> ++numProbes;</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;}</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;Response::Status HyPerLayer::outputProbeParams() {</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = 0; p &lt; numProbes; p++) {</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;      probes[p]-&gt;<a class="code" href="classPV_1_1BaseObject.html#a2b24e49874218ac1b84418df1d9410ad">writeParams</a>();</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;   }</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;}</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;Response::Status HyPerLayer::outputState(<span class="keywordtype">double</span> timef) {</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;   io_timer-&gt;start();</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numProbes; i++) {</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;      probes[i]-&gt;<a class="code" href="classPV_1_1BaseProbe.html#aad8a3674a2abeafb8c16fb17e28f826a">outputStateWrapper</a>(timef, parent-&gt;getDeltaTime());</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;   }</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;   <span class="keywordflow">if</span> (timef &gt;= (writeTime - (parent-&gt;getDeltaTime() / 2)) &amp;&amp; writeStep &gt;= 0) {</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;      <span class="keywordtype">int</span> writeStatus = PV_SUCCESS;</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;      writeTime += writeStep;</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;      <span class="keywordflow">if</span> (sparseLayer) {</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;         writeStatus = writeActivitySparse(timef);</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;      }</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;         writeStatus = writeActivity(timef);</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;      }</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;      FatalIf(</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;            writeStatus != PV_SUCCESS,</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;            <span class="stringliteral">&quot;%s: outputState failed on rank %d process.\n&quot;</span>,</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;            getDescription_c(),</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;            parent-&gt;columnId());</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;   }</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;   io_timer-&gt;stop();</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;}</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;Response::Status HyPerLayer::readStateFromCheckpoint(<a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer) {</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;   <span class="keywordflow">if</span> (initializeFromCheckpointFlag) {</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;      readActivityFromCheckpoint(checkpointer);</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;      readVFromCheckpoint(checkpointer);</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;      readDelaysFromCheckpoint(checkpointer);</div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;      updateAllActiveIndices();</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;      <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;   }</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;   <span class="keywordflow">else</span> {</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;      <span class="keywordflow">return</span> Response::NO_ACTION;</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;   }</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;}</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;<span class="keywordtype">void</span> HyPerLayer::readActivityFromCheckpoint(<a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer) {</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;   checkpointer-&gt;readNamedCheckpointEntry(std::string(name), std::string(<span class="stringliteral">&quot;A&quot;</span>), <span class="keyword">false</span>);</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;}</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;<span class="keywordtype">void</span> HyPerLayer::readVFromCheckpoint(<a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer) {</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;   <span class="keywordflow">if</span> (getV() != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;      checkpointer-&gt;readNamedCheckpointEntry(std::string(name), std::string(<span class="stringliteral">&quot;V&quot;</span>), <span class="keyword">false</span>);</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;   }</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;}</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;<span class="keywordtype">void</span> HyPerLayer::readDelaysFromCheckpoint(<a class="code" href="classPV_1_1Checkpointer.html">Checkpointer</a> *checkpointer) {</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;   checkpointer-&gt;readNamedCheckpointEntry(std::string(name), std::string(<span class="stringliteral">&quot;Delays&quot;</span>), <span class="keyword">false</span>);</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;}</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;<span class="comment">// readBufferFile and readDataStoreFromFile were removed Jan 23, 2017.</span></div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;<span class="comment">// They were only used by checkpointing, which is now handled by the</span></div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;<span class="comment">// CheckpointEntry class hierarchy.</span></div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;Response::Status HyPerLayer::processCheckpointRead() {</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;   updateAllActiveIndices();</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;   <span class="keywordflow">return</span> Response::SUCCESS;</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;}</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;<span class="keywordtype">int</span> HyPerLayer::writeActivitySparse(<span class="keywordtype">double</span> timed) {</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;   <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> cube      = publisher-&gt;<a class="code" href="classPV_1_1Publisher.html#a774cd7c66353e2ecc113048ba3754e19">createCube</a>(0 <span class="comment">/*delay*/</span>);</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;   <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *loc = getLayerLoc();</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;   pvAssert(cube.numItems == loc-&gt;nbatch * getNumExtended());</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> mpiBatchDimension = getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#af8e101d1e9d1c95210c03d6d93d6cf42">getBatchDimension</a>();</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> numFrames         = mpiBatchDimension * loc-&gt;nbatch;</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> frame = 0; frame &lt; numFrames; frame++) {</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;      <span class="keywordtype">int</span> <span class="keyword">const</span> localBatchIndex = frame % loc-&gt;nbatch;</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;      <span class="keywordtype">int</span> <span class="keyword">const</span> mpiBatchIndex   = frame / loc-&gt;nbatch; <span class="comment">// Integer division</span></div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;      pvAssert(mpiBatchIndex * loc-&gt;nbatch + localBatchIndex == frame);</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;      <a class="code" href="classPV_1_1SparseList.html">SparseList&lt;float&gt;</a> list;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;      <span class="keyword">auto</span> *activeIndicesBatch   = (<a class="code" href="classPV_1_1SparseList.html">SparseList&lt;float&gt;::Entry</a> <span class="keyword">const</span> *)cube.activeIndices;</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;      <span class="keyword">auto</span> *activeIndicesElement = &amp;activeIndicesBatch[localBatchIndex * getNumExtended()];</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;      <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *loc      = getLayerLoc();</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;      <span class="keywordtype">int</span> nxExt                  = loc-&gt;nx + loc-&gt;halo.lt + loc-&gt;halo.rt;</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;      <span class="keywordtype">int</span> nyExt                  = loc-&gt;ny + loc-&gt;halo.dn + loc-&gt;halo.up;</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;      <span class="keywordtype">int</span> nf                     = loc-&gt;nf;</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">long</span> <span class="keywordtype">int</span> k = 0; k &lt; cube.numActive[localBatchIndex]; k++) {</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;         <a class="code" href="classPV_1_1SparseList.html">SparseList&lt;float&gt;::Entry</a> entry = activeIndicesElement[k];</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;         <span class="keywordtype">int</span> index                      = (int)entry.index;</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;         <span class="comment">// Location is local extended; need global restricted.</span></div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;         <span class="comment">// Get local restricted coordinates.</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;         <span class="keywordtype">int</span> x = kxPos(index, nxExt, nyExt, nf) - loc-&gt;halo.lt;</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;         <span class="keywordflow">if</span> (x &lt; 0 or x &gt;= loc-&gt;nx) {</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;         }</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;         <span class="keywordtype">int</span> y = kyPos(index, nxExt, nyExt, nf) - loc-&gt;halo.up;</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;         <span class="keywordflow">if</span> (y &lt; 0 or y &gt;= loc-&gt;ny) {</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;         }</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;         <span class="comment">// Convert to global restricted coordinates.</span></div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;         x += loc-&gt;kx0;</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;         y += loc-&gt;ky0;</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;         <span class="keywordtype">int</span> f = featureIndex(index, nxExt, nyExt, nf);</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;         <span class="comment">// Get global restricted index.</span></div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;         entry.index = (uint32_t)kIndex(x, y, f, loc-&gt;nxGlobal, loc-&gt;nyGlobal, nf);</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;         list.addEntry(entry);</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;      }</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;      <span class="keyword">auto</span> gatheredList =</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;            BufferUtils::gatherSparse(getMPIBlock(), list, mpiBatchIndex, 0 <span class="comment">/*root process*/</span>);</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;      <span class="keywordflow">if</span> (getMPIBlock()-&gt;getRank() == 0) {</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;         <span class="keywordtype">long</span> fpos = mOutputStateStream-&gt;getOutPos();</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;         <span class="keywordflow">if</span> (fpos == 0L) {</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;            <a class="code" href="structPV_1_1BufferUtils_1_1ActivityHeader.html">BufferUtils::ActivityHeader</a> header = BufferUtils::buildSparseActivityHeader&lt;float&gt;(</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;                  loc-&gt;nx * getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#a6500c9a8167d207b65bb9cb46df5c0da">getNumColumns</a>(),</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;                  loc-&gt;ny * getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#a5bdd8b3d3a845d883fa79a35e400039b">getNumRows</a>(),</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;                  loc-&gt;nf,</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;                  0 <span class="comment">/* numBands */</span>); <span class="comment">// numBands will be set by call to incrementNBands.</span></div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;            header.timestamp = timed;</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;            BufferUtils::writeActivityHeader(*mOutputStateStream, header);</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;         }</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;         BufferUtils::writeSparseFrame(*mOutputStateStream, &amp;gatheredList, timed);</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;      }</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;   }</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;   writeActivitySparseCalls += numFrames;</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;   updateNBands(writeActivitySparseCalls);</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;}</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;<span class="comment">// write non-spiking activity</span></div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;<span class="keywordtype">int</span> HyPerLayer::writeActivity(<span class="keywordtype">double</span> timed) {</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;   <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> cube      = publisher-&gt;<a class="code" href="classPV_1_1Publisher.html#a774cd7c66353e2ecc113048ba3754e19">createCube</a>(0);</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;   <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *loc = getLayerLoc();</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;   pvAssert(cube.numItems == loc-&gt;nbatch * getNumExtended());</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;   <a class="code" href="structPVHalo__.html">PVHalo</a> <span class="keyword">const</span> &amp;halo   = loc-&gt;halo;</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> nxExtLocal = loc-&gt;nx + halo.lt + halo.rt;</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> nyExtLocal = loc-&gt;ny + halo.dn + halo.up;</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> nf         = loc-&gt;nf;</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> mpiBatchDimension = getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#af8e101d1e9d1c95210c03d6d93d6cf42">getBatchDimension</a>();</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;   <span class="keywordtype">int</span> <span class="keyword">const</span> numFrames         = mpiBatchDimension * loc-&gt;nbatch;</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> frame = 0; frame &lt; numFrames; frame++) {</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;      <span class="keywordtype">int</span> <span class="keyword">const</span> localBatchIndex = frame % loc-&gt;nbatch;</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;      <span class="keywordtype">int</span> <span class="keyword">const</span> mpiBatchIndex   = frame / loc-&gt;nbatch; <span class="comment">// Integer division</span></div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;      pvAssert(mpiBatchIndex * loc-&gt;nbatch + localBatchIndex == frame);</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;      <span class="keywordtype">float</span> *data = &amp;cube.data[localBatchIndex * getNumExtended()];</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;      <a class="code" href="classPV_1_1Buffer.html">Buffer&lt;float&gt;</a> localBuffer(data, nxExtLocal, nyExtLocal, nf);</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;      localBuffer.crop(loc-&gt;nx, loc-&gt;ny, <a class="code" href="classPV_1_1Buffer.html">Buffer&lt;float&gt;::CENTER</a>);</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;      <a class="code" href="classPV_1_1Buffer.html">Buffer&lt;float&gt;</a> blockBuffer = BufferUtils::gather&lt;float&gt;(</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;            getMPIBlock(), localBuffer, loc-&gt;nx, loc-&gt;ny, mpiBatchIndex, 0 <span class="comment">/*root process*/</span>);</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;      <span class="comment">// At this point, the rank-zero process has the entire block for the batch element,</span></div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;      <span class="comment">// regardless of what the mpiBatchIndex is.</span></div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;      <span class="keywordflow">if</span> (getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#a26777df69a9a3dbf8b084da315c1e86e">getRank</a>() == 0) {</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;         <span class="keywordtype">long</span> fpos = mOutputStateStream-&gt;getOutPos();</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;         <span class="keywordflow">if</span> (fpos == 0L) {</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;            <a class="code" href="structPV_1_1BufferUtils_1_1ActivityHeader.html">BufferUtils::ActivityHeader</a> header = BufferUtils::buildActivityHeader&lt;float&gt;(</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;                  loc-&gt;nx * getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#a6500c9a8167d207b65bb9cb46df5c0da">getNumColumns</a>(),</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;                  loc-&gt;ny * getMPIBlock()-&gt;<a class="code" href="classPV_1_1MPIBlock.html#a5bdd8b3d3a845d883fa79a35e400039b">getNumRows</a>(),</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;                  loc-&gt;nf,</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;                  0 <span class="comment">/* numBands */</span>); <span class="comment">// numBands will be set by call to incrementNBands.</span></div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;            header.timestamp = timed;</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;            BufferUtils::writeActivityHeader(*mOutputStateStream, header);</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;         }</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;         BufferUtils::writeFrame&lt;float&gt;(*mOutputStateStream, &amp;blockBuffer, timed);</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;      }</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;   }</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;   writeActivityCalls += numFrames;</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;   updateNBands(writeActivityCalls);</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;   <span class="keywordflow">return</span> PV_SUCCESS;</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;}</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="keywordtype">void</span> HyPerLayer::updateNBands(<span class="keywordtype">int</span> <span class="keyword">const</span> numCalls) {</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;   <span class="comment">// Only the root process needs to maintain INDEX_NBANDS, so only the root process modifies</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;   <span class="comment">// numCalls</span></div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;   <span class="comment">// This way, writeActivityCalls does not need to be coordinated across MPI</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;   <span class="keywordflow">if</span> (mOutputStateStream != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;      <span class="keywordtype">long</span> <span class="keywordtype">int</span> fpos = mOutputStateStream-&gt;getOutPos();</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;      mOutputStateStream-&gt;setOutPos(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * INDEX_NBANDS, <span class="keyword">true</span> <span class="comment">/*fromBeginning*/</span>);</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;      mOutputStateStream-&gt;write(&amp;numCalls, (<span class="keywordtype">long</span>)<span class="keyword">sizeof</span>(numCalls));</div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;      mOutputStateStream-&gt;setOutPos(fpos, <span class="keyword">true</span> <span class="comment">/*fromBeginning*/</span>);</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;   }</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;}</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;<span class="keywordtype">bool</span> HyPerLayer::localDimensionsEqual(<a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *loc1, <a class="code" href="structPVLayerLoc__.html">PVLayerLoc</a> <span class="keyword">const</span> *loc2) {</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;   <span class="keywordflow">return</span> loc1-&gt;nbatch == loc2-&gt;nbatch &amp;&amp; loc1-&gt;nx == loc2-&gt;nx &amp;&amp; loc1-&gt;ny == loc2-&gt;ny</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;          &amp;&amp; loc1-&gt;nf == loc2-&gt;nf &amp;&amp; loc1-&gt;halo.lt == loc2-&gt;halo.lt</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;          &amp;&amp; loc1-&gt;halo.rt == loc2-&gt;halo.rt &amp;&amp; loc1-&gt;halo.dn == loc2-&gt;halo.dn</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;          &amp;&amp; loc1-&gt;halo.up == loc2-&gt;halo.up;</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;}</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToNorthWest(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;   }</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;   <span class="keywordtype">int</span> nbatch     = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;   <span class="keywordtype">int</span> nf         = dest-&gt;loc.nf;</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;   <span class="keywordtype">int</span> leftBorder = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;   <span class="keywordtype">int</span> topBorder  = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;   <span class="keywordtype">size_t</span> sb      = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;   <span class="keywordtype">size_t</span> sf      = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;   <span class="keywordtype">size_t</span> sx      = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;   <span class="keywordtype">size_t</span> sy      = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;      <span class="keywordtype">float</span> *src0 = srcData + topBorder * sy + leftBorder * sx;</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;      <span class="keywordtype">float</span> *dst0 = srcData + (topBorder - 1) * sy + (leftBorder - 1) * sx;</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; topBorder; ky++) {</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 - ky * sy;</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;         <span class="keywordtype">float</span> *from = src0 + ky * sy;</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; leftBorder; kx++) {</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;            }</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;            to -= nf;</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;            from += nf;</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;         }</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;      }</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;   }</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;}</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToNorth(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;   }</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;   <span class="keywordtype">int</span> nx         = clayer-&gt;loc.nx;</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;   <span class="keywordtype">int</span> nf         = clayer-&gt;loc.nf;</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;   <span class="keywordtype">int</span> leftBorder = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;   <span class="keywordtype">int</span> topBorder  = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;   <span class="keywordtype">int</span> nbatch     = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;   <span class="keywordtype">size_t</span> sb      = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;   <span class="keywordtype">size_t</span> sf      = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;   <span class="keywordtype">size_t</span> sx      = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;   <span class="keywordtype">size_t</span> sy      = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;      <span class="keywordtype">float</span> *src0     = srcData + topBorder * sy + leftBorder * sx;</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;      <span class="keywordtype">float</span> *dst0     = destData + (topBorder - 1) * sy + leftBorder * sx;</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; topBorder; ky++) {</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 - ky * sy;</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;         <span class="keywordtype">float</span> *from = src0 + ky * sy;</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; nx; kx++) {</div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;            }</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;            to += nf;</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;            from += nf;</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;         }</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;      }</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;   }</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;}</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToNorthEast(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;   }</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;   <span class="keywordtype">int</span> nx          = dest-&gt;loc.nx;</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;   <span class="keywordtype">int</span> nf          = dest-&gt;loc.nf;</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;   <span class="keywordtype">int</span> leftBorder  = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;   <span class="keywordtype">int</span> rightBorder = dest-&gt;loc.halo.rt;</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;   <span class="keywordtype">int</span> topBorder   = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;   <span class="keywordtype">int</span> nbatch      = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;   <span class="keywordtype">size_t</span> sb       = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;   <span class="keywordtype">size_t</span> sf       = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;   <span class="keywordtype">size_t</span> sx       = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;   <span class="keywordtype">size_t</span> sy       = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;      <span class="keywordtype">float</span> *src0     = srcData + topBorder * sy + (nx + leftBorder - 1) * sx;</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;      <span class="keywordtype">float</span> *dst0     = destData + (topBorder - 1) * sy + (nx + leftBorder) * sx;</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; topBorder; ky++) {</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 - ky * sy;</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;         <span class="keywordtype">float</span> *from = src0 + ky * sy;</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; rightBorder; kx++) {</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;            }</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;            to += nf;</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;            from -= nf;</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;         }</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;      }</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;   }</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;}</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToWest(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;   }</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;   <span class="keywordtype">int</span> ny         = dest-&gt;loc.ny;</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;   <span class="keywordtype">int</span> nf         = dest-&gt;loc.nf;</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;   <span class="keywordtype">int</span> leftBorder = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;   <span class="keywordtype">int</span> topBorder  = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;   <span class="keywordtype">int</span> nbatch     = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;   <span class="keywordtype">size_t</span> sb      = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;   <span class="keywordtype">size_t</span> sf      = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;   <span class="keywordtype">size_t</span> sx      = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;   <span class="keywordtype">size_t</span> sy      = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;      <span class="keywordtype">float</span> *src0     = srcData + topBorder * sy + leftBorder * sx;</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;      <span class="keywordtype">float</span> *dst0     = destData + topBorder * sy + (leftBorder - 1) * sx;</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; ny; ky++) {</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 + ky * sy;</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;         <span class="keywordtype">float</span> *from = src0 + ky * sy;</div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; leftBorder; kx++) {</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;            }</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;            to -= nf;</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;            from += nf;</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;         }</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;      }</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;   }</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;}</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToEast(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;   }</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;   <span class="keywordtype">int</span> nx          = clayer-&gt;loc.nx;</div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;   <span class="keywordtype">int</span> ny          = clayer-&gt;loc.ny;</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;   <span class="keywordtype">int</span> nf          = clayer-&gt;loc.nf;</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;   <span class="keywordtype">int</span> leftBorder  = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;   <span class="keywordtype">int</span> rightBorder = dest-&gt;loc.halo.rt;</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;   <span class="keywordtype">int</span> topBorder   = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;   <span class="keywordtype">int</span> nbatch      = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;   <span class="keywordtype">size_t</span> sb       = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;   <span class="keywordtype">size_t</span> sf       = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;   <span class="keywordtype">size_t</span> sx       = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;   <span class="keywordtype">size_t</span> sy       = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;      <span class="keywordtype">float</span> *src0     = srcData + topBorder * sy + (nx + leftBorder - 1) * sx;</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;      <span class="keywordtype">float</span> *dst0     = destData + topBorder * sy + (nx + leftBorder) * sx;</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; ny; ky++) {</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 + ky * sy;</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;         <span class="keywordtype">float</span> *from = src0 + ky * sy;</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; rightBorder; kx++) {</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;            }</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;            to += nf;</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;            from -= nf;</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;         }</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;      }</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;   }</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;}</div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;</div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToSouthWest(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;   }</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;   <span class="keywordtype">int</span> ny           = dest-&gt;loc.ny;</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;   <span class="keywordtype">int</span> nf           = dest-&gt;loc.nf;</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;   <span class="keywordtype">int</span> leftBorder   = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;   <span class="keywordtype">int</span> topBorder    = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;   <span class="keywordtype">int</span> bottomBorder = dest-&gt;loc.halo.dn;</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;   <span class="keywordtype">int</span> nbatch       = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;   <span class="keywordtype">size_t</span> sb        = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;   <span class="keywordtype">size_t</span> sf        = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;   <span class="keywordtype">size_t</span> sx        = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;   <span class="keywordtype">size_t</span> sy        = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;</div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;      <span class="keywordtype">float</span> *src0     = srcData + (ny + topBorder - 1) * sy + leftBorder * sx;</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;      <span class="keywordtype">float</span> *dst0     = destData + (ny + topBorder) * sy + (leftBorder - 1) * sx;</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;</div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; bottomBorder; ky++) {</div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 + ky * sy;</div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;         <span class="keywordtype">float</span> *from = src0 - ky * sy;</div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; leftBorder; kx++) {</div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;            }</div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;            to -= nf;</div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;            from += nf;</div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;         }</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;      }</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;   }</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;}</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToSouth(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;   }</div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;   <span class="keywordtype">int</span> nx           = dest-&gt;loc.nx;</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;   <span class="keywordtype">int</span> ny           = dest-&gt;loc.ny;</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;   <span class="keywordtype">int</span> nf           = dest-&gt;loc.nf;</div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;   <span class="keywordtype">int</span> leftBorder   = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;   <span class="keywordtype">int</span> rightBorder  = dest-&gt;loc.halo.rt;</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;   <span class="keywordtype">int</span> topBorder    = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;   <span class="keywordtype">int</span> bottomBorder = dest-&gt;loc.halo.dn;</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;   <span class="keywordtype">int</span> nbatch       = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;   <span class="keywordtype">size_t</span> sb        = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;   <span class="keywordtype">size_t</span> sf        = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;   <span class="keywordtype">size_t</span> sx        = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;   <span class="keywordtype">size_t</span> sy        = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;</div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;      <span class="keywordtype">float</span> *src0     = srcData + (ny + topBorder - 1) * sy + leftBorder * sx;</div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;      <span class="keywordtype">float</span> *dst0     = destData + (ny + topBorder) * sy + leftBorder * sx;</div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;</div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; bottomBorder; ky++) {</div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 + ky * sy;</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;         <span class="keywordtype">float</span> *from = src0 - ky * sy;</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; nx; kx++) {</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;            }</div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;            to += nf;</div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;            from += nf;</div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;         }</div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;      }</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;   }</div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;}</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;<span class="keywordtype">int</span> HyPerLayer::mirrorToSouthEast(<a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *dest, <a class="code" href="structPVLayerCube__.html">PVLayerCube</a> *src) {</div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;   <span class="keywordflow">if</span> (!localDimensionsEqual(&amp;dest-&gt;loc, &amp;src-&gt;loc)) {</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;      <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;   }</div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;   <span class="keywordtype">int</span> nx           = dest-&gt;loc.nx;</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;   <span class="keywordtype">int</span> ny           = dest-&gt;loc.ny;</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;   <span class="keywordtype">int</span> nf           = dest-&gt;loc.nf;</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;   <span class="keywordtype">int</span> leftBorder   = dest-&gt;loc.halo.lt;</div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;   <span class="keywordtype">int</span> rightBorder  = dest-&gt;loc.halo.rt;</div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;   <span class="keywordtype">int</span> topBorder    = dest-&gt;loc.halo.up;</div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;   <span class="keywordtype">int</span> bottomBorder = dest-&gt;loc.halo.dn;</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;   <span class="keywordtype">int</span> nbatch       = dest-&gt;loc.nbatch;</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;   <span class="keywordtype">size_t</span> sb        = strideBExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;   <span class="keywordtype">size_t</span> sf        = strideFExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;   <span class="keywordtype">size_t</span> sx        = strideXExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;   <span class="keywordtype">size_t</span> sy        = strideYExtended(&amp;dest-&gt;loc);</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b = 0; b &lt; nbatch; b++) {</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;      <span class="keywordtype">float</span> *srcData  = src-&gt;data + b * sb;</div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;      <span class="keywordtype">float</span> *destData = dest-&gt;data + b * sb;</div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;      <span class="keywordtype">float</span> *src0     = srcData + (ny + topBorder - 1) * sy + (nx + leftBorder - 1) * sx;</div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;      <span class="keywordtype">float</span> *dst0     = destData + (ny + topBorder) * sy + (nx + leftBorder) * sx;</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ky = 0; ky &lt; bottomBorder; ky++) {</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;         <span class="keywordtype">float</span> *to   = dst0 + ky * sy;</div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;         <span class="keywordtype">float</span> *from = src0 - ky * sy;</div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kx = 0; kx &lt; rightBorder; kx++) {</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> kf = 0; kf &lt; nf; kf++) {</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;               to[kf * sf] = from[kf * sf];</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;            }</div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;            to += nf;</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;            from -= nf;</div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;         }</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;      }</div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;   }</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;}</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;} <span class="comment">// end of PV namespace</span></div><div class="ttc" id="structPVLayer___html"><div class="ttname"><a href="structPVLayer__.html">PVLayer_</a></div><div class="ttdef"><b>Definition:</b> <a href="pv__types_8h_source.html#l00074">pv_types.h:74</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_adf78265c6f0dc7bb94286934a9e5bd7a"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#adf78265c6f0dc7bb94286934a9e5bd7a">PV::HyPerLayer::ioParamsFillGroup</a></div><div class="ttdeci">virtual int ioParamsFillGroup(enum ParamsIOFlag ioFlag) override</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00571">HyPerLayer.cpp:571</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_abf47d71a0d1acabaebf97125c196f870"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#abf47d71a0d1acabaebf97125c196f870">PV::HyPerLayer::ioParam_triggerOffset</a></div><div class="ttdeci">virtual void ioParam_triggerOffset(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">triggerOffset: If triggerLayer is set, triggers &lt;triggerOffset&gt; timesteps before target trigger ...</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00761">HyPerLayer.cpp:761</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a06eb20101adacc02c0963e981816dfa2"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a06eb20101adacc02c0963e981816dfa2">PV::HyPerLayer::resetStateOnTrigger</a></div><div class="ttdeci">virtual void resetStateOnTrigger()</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01769">HyPerLayer.cpp:1769</a></div></div>
<div class="ttc" id="classPV_1_1HyPerCol_html"><div class="ttname"><a href="classPV_1_1HyPerCol.html">PV::HyPerCol</a></div><div class="ttdef"><b>Definition:</b> <a href="HyPerCol_8hpp_source.html#l00041">HyPerCol.hpp:41</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a5cde54075d384518c5516f8c079ca26d"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a5cde54075d384518c5516f8c079ca26d">PV::HyPerLayer::ioParam_triggerBehavior</a></div><div class="ttdeci">virtual void ioParam_triggerBehavior(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">triggerBehavior: If triggerLayerName is set, this parameter specifies how the trigger is handled...</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00774">HyPerLayer.cpp:774</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_af6bf682a8b67348ca0cf200a9ba3a44b"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#af6bf682a8b67348ca0cf200a9ba3a44b">PV::HyPerLayer::allocateDeviceBuffers</a></div><div class="ttdeci">virtual int allocateDeviceBuffers()</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01090">HyPerLayer.cpp:1090</a></div></div>
<div class="ttc" id="classPV_1_1MPIBlock_html_a6500c9a8167d207b65bb9cb46df5c0da"><div class="ttname"><a href="classPV_1_1MPIBlock.html#a6500c9a8167d207b65bb9cb46df5c0da">PV::MPIBlock::getNumColumns</a></div><div class="ttdeci">int getNumColumns() const </div><div class="ttdef"><b>Definition:</b> <a href="MPIBlock_8hpp_source.html#l00130">MPIBlock.hpp:130</a></div></div>
<div class="ttc" id="classPV_1_1PVParams_html_ab1216243eb516e4fc5fdb3255005d10f"><div class="ttname"><a href="classPV_1_1PVParams.html#ab1216243eb516e4fc5fdb3255005d10f">PV::PVParams::present</a></div><div class="ttdeci">int present(const char *groupName, const char *paramName)</div><div class="ttdef"><b>Definition:</b> <a href="PVParams_8cpp_source.html#l01254">PVParams.cpp:1254</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a08b613ce7777b06a21ef20c85c739f4b"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a08b613ce7777b06a21ef20c85c739f4b">PV::HyPerLayer::ioParam_writeStep</a></div><div class="ttdeci">virtual void ioParam_writeStep(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">writeStep: Specifies how often to output a pvp file for this layer </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00825">HyPerLayer.cpp:825</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a65e4c8eaa17655ef4c03147beed369b3"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a65e4c8eaa17655ef4c03147beed369b3">PV::HyPerLayer::ioParam_phase</a></div><div class="ttdeci">virtual void ioParam_phase(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">phase: Defines the ordering in which each layer is updated </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00651">HyPerLayer.cpp:651</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a2e384c9ee929aef35ba67c526ff78fd2"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a2e384c9ee929aef35ba67c526ff78fd2">PV::HyPerLayer::isAllInputReady</a></div><div class="ttdeci">bool isAllInputReady()</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01923">HyPerLayer.cpp:1923</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_abea1a703930c35493f42ea38bf9a0118"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#abea1a703930c35493f42ea38bf9a0118">PV::HyPerLayer::allocateRestrictedBuffer</a></div><div class="ttdeci">void allocateRestrictedBuffer(float **buf, const char *bufname)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00325">HyPerLayer.cpp:325</a></div></div>
<div class="ttc" id="classPV_1_1Publisher_html_a774cd7c66353e2ecc113048ba3754e19"><div class="ttname"><a href="classPV_1_1Publisher.html#a774cd7c66353e2ecc113048ba3754e19">PV::Publisher::createCube</a></div><div class="ttdeci">PVLayerCube createCube(int delay=0)</div><div class="ttdef"><b>Definition:</b> <a href="Publisher_8cpp_source.html#l00060">Publisher.cpp:60</a></div></div>
<div class="ttc" id="classPV_1_1MPIBlock_html_a5bdd8b3d3a845d883fa79a35e400039b"><div class="ttname"><a href="classPV_1_1MPIBlock.html#a5bdd8b3d3a845d883fa79a35e400039b">PV::MPIBlock::getNumRows</a></div><div class="ttdeci">int getNumRows() const </div><div class="ttdef"><b>Definition:</b> <a href="MPIBlock_8hpp_source.html#l00125">MPIBlock.hpp:125</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a66b9f708d3e8f077a7b4fe8d51b4b138"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a66b9f708d3e8f077a7b4fe8d51b4b138">PV::HyPerLayer::ioParam_initializeFromCheckpointFlag</a></div><div class="ttdeci">virtual void ioParam_initializeFromCheckpointFlag(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">initializeFromCheckpointFlag: If set to true, initialize using checkpoint direcgtory set in HyPerCol...</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00671">HyPerLayer.cpp:671</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a4bc274528390800826b2e9fdbbf19313"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a4bc274528390800826b2e9fdbbf19313">PV::HyPerLayer::isExchangeFinished</a></div><div class="ttdeci">bool isExchangeFinished(int delay=0)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01921">HyPerLayer.cpp:1921</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a20ef648236095449ebc8cc86716915ac"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a20ef648236095449ebc8cc86716915ac">PV::HyPerLayer::ioParam_sparseLayer</a></div><div class="ttdeci">virtual void ioParam_sparseLayer(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">sparseLayer: Specifies if the layer should be considered sparese for optimization and output ...</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00852">HyPerLayer.cpp:852</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a38dbdd16a68095acea310a7f7003fa13"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a38dbdd16a68095acea310a7f7003fa13">PV::HyPerLayer::ioParam_nf</a></div><div class="ttdeci">virtual void ioParam_nf(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">nf: Defines how many features this layer has </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00647">HyPerLayer.cpp:647</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html"><div class="ttname"><a href="classPV_1_1HyPerLayer.html">PV::HyPerLayer</a></div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8hpp_source.html#l00064">HyPerLayer.hpp:64</a></div></div>
<div class="ttc" id="structPVLayerCube___html"><div class="ttname"><a href="structPVLayerCube__.html">PVLayerCube_</a></div><div class="ttdef"><b>Definition:</b> <a href="pv__types_8h_source.html#l00054">pv_types.h:54</a></div></div>
<div class="ttc" id="structPVHalo___html"><div class="ttname"><a href="structPVHalo__.html">PVHalo_</a></div><div class="ttdef"><b>Definition:</b> <a href="PVLayerLoc_8h_source.html#l00014">PVLayerLoc.h:14</a></div></div>
<div class="ttc" id="classPV_1_1BaseInitV_html_a2c8dbf874a7bbcabed1af1ac71b73756"><div class="ttname"><a href="classPV_1_1BaseInitV.html#a2c8dbf874a7bbcabed1af1ac71b73756">PV::BaseInitV::ioParamsFillGroup</a></div><div class="ttdeci">virtual int ioParamsFillGroup(enum ParamsIOFlag ioFlag) override</div><div class="ttdef"><b>Definition:</b> <a href="BaseInitV_8cpp_source.html#l00034">BaseInitV.cpp:34</a></div></div>
<div class="ttc" id="classPV_1_1Communicator_html"><div class="ttname"><a href="classPV_1_1Communicator.html">PV::Communicator</a></div><div class="ttdef"><b>Definition:</b> <a href="Communicator_8hpp_source.html#l00021">Communicator.hpp:21</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a4cb78e4b327b84207199f222cd79f808"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a4cb78e4b327b84207199f222cd79f808">PV::HyPerLayer::ioParam_triggerLayerName</a></div><div class="ttdeci">virtual void ioParam_triggerLayerName(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">triggerLayerName: Specifies the name of the layer that this layer triggers off of. If set to NULL or the empty string, the layer does not trigger but updates its state on every timestep. </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00702">HyPerLayer.cpp:702</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a7ddccdd0e2b3db084c4c3775341d7664"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a7ddccdd0e2b3db084c4c3775341d7664">PV::HyPerLayer::getDeltaUpdateTime</a></div><div class="ttdeci">virtual double getDeltaUpdateTime()</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01677">HyPerLayer.cpp:1677</a></div></div>
<div class="ttc" id="namespacePV_1_1Response_html_aa3623495ae9596716973fbe1f4e76bab"><div class="ttname"><a href="namespacePV_1_1Response.html#aa3623495ae9596716973fbe1f4e76bab">PV::Response::completed</a></div><div class="ttdeci">static bool completed(Status &amp;a)</div><div class="ttdef"><b>Definition:</b> <a href="Response_8hpp_source.html#l00049">Response.hpp:49</a></div></div>
<div class="ttc" id="classPV_1_1MPIBlock_html_a26777df69a9a3dbf8b084da315c1e86e"><div class="ttname"><a href="classPV_1_1MPIBlock.html#a26777df69a9a3dbf8b084da315c1e86e">PV::MPIBlock::getRank</a></div><div class="ttdeci">int getRank() const </div><div class="ttdef"><b>Definition:</b> <a href="MPIBlock_8hpp_source.html#l00100">MPIBlock.hpp:100</a></div></div>
<div class="ttc" id="classPV_1_1BaseConnection_html"><div class="ttname"><a href="classPV_1_1BaseConnection.html">PV::BaseConnection</a></div><div class="ttdef"><b>Definition:</b> <a href="BaseConnection_8hpp_source.html#l00023">BaseConnection.hpp:23</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a4427fa8d7ed110c3cc45d243a425c16f"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a4427fa8d7ed110c3cc45d243a425c16f">PV::HyPerLayer::initialize</a></div><div class="ttdeci">int initialize(const char *name, HyPerCol *hc)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00129">HyPerLayer.cpp:129</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a69fcd09e34fbb76fc3e6434443c2fe0e"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a69fcd09e34fbb76fc3e6434443c2fe0e">PV::HyPerLayer::ioParam_valueBC</a></div><div class="ttdeci">virtual void ioParam_valueBC(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">valueBC: If mirrorBC is set to true, Uses the specified value for the margin area ...</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00664">HyPerLayer.cpp:664</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a60536458c87edac02bd49815a7524662"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a60536458c87edac02bd49815a7524662">PV::HyPerLayer::allocateExtendedBuffer</a></div><div class="ttdeci">void allocateExtendedBuffer(float **buf, const char *bufname)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00329">HyPerLayer.cpp:329</a></div></div>
<div class="ttc" id="classPV_1_1MPIBlock_html_af8e101d1e9d1c95210c03d6d93d6cf42"><div class="ttname"><a href="classPV_1_1MPIBlock.html#af8e101d1e9d1c95210c03d6d93d6cf42">PV::MPIBlock::getBatchDimension</a></div><div class="ttdeci">int getBatchDimension() const </div><div class="ttdef"><b>Definition:</b> <a href="MPIBlock_8hpp_source.html#l00135">MPIBlock.hpp:135</a></div></div>
<div class="ttc" id="classPV_1_1CheckpointEntryPvpBuffer_html"><div class="ttname"><a href="classPV_1_1CheckpointEntryPvpBuffer.html">PV::CheckpointEntryPvpBuffer</a></div><div class="ttdef"><b>Definition:</b> <a href="CheckpointEntryPvpBuffer_8hpp_source.html#l00018">CheckpointEntryPvpBuffer.hpp:18</a></div></div>
<div class="ttc" id="classPV_1_1BaseObject_html"><div class="ttname"><a href="classPV_1_1BaseObject.html">PV::BaseObject</a></div><div class="ttdef"><b>Definition:</b> <a href="BaseObject_8hpp_source.html#l00044">BaseObject.hpp:44</a></div></div>
<div class="ttc" id="classPV_1_1BaseInitV_html"><div class="ttname"><a href="classPV_1_1BaseInitV.html">PV::BaseInitV</a></div><div class="ttdef"><b>Definition:</b> <a href="BaseInitV_8hpp_source.html#l00015">BaseInitV.hpp:15</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a8a8f1f11808763cf05727f5e15f595a8"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a8a8f1f11808763cf05727f5e15f595a8">PV::HyPerLayer::needUpdate</a></div><div class="ttdeci">virtual bool needUpdate(double simTime, double dt)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01695">HyPerLayer.cpp:1695</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a0d14e0e4bcfd9d10aa0918503ce4a7d6"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a0d14e0e4bcfd9d10aa0918503ce4a7d6">PV::HyPerLayer::ioParam_mirrorBCflag</a></div><div class="ttdeci">virtual void ioParam_mirrorBCflag(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">mirrorBCflag: If set to true, the margin will mirror the data </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00660">HyPerLayer.cpp:660</a></div></div>
<div class="ttc" id="classPV_1_1Random_html"><div class="ttname"><a href="classPV_1_1Random.html">PV::Random</a></div><div class="ttdef"><b>Definition:</b> <a href="Random_8hpp_source.html#l00029">Random.hpp:29</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_aded80bac62512e73f789bd209933717f"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#aded80bac62512e73f789bd209933717f">PV::HyPerLayer::ioParam_triggerResetLayerName</a></div><div class="ttdeci">virtual void ioParam_triggerResetLayerName(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">triggerResetLayerName: If triggerLayerName is set, this parameter specifies the layer to use for upda...</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00814">HyPerLayer.cpp:814</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a5e0693ed1e7c21c88180e40a79613acb"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a5e0693ed1e7c21c88180e40a79613acb">PV::HyPerLayer::addRecvConn</a></div><div class="ttdeci">void addRecvConn(BaseConnection *conn)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01235">HyPerLayer.cpp:1235</a></div></div>
<div class="ttc" id="classPV_1_1LayerProbe_html"><div class="ttname"><a href="classPV_1_1LayerProbe.html">PV::LayerProbe</a></div><div class="ttdef"><b>Definition:</b> <a href="LayerProbe_8hpp_source.html#l00025">LayerProbe.hpp:25</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a651cb7cee711755c35fd7d9b450cdf5e"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a651cb7cee711755c35fd7d9b450cdf5e">PV::HyPerLayer::ioParam_InitVType</a></div><div class="ttdeci">virtual void ioParam_InitVType(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">initVType: Specifies how to initialize the V buffer. </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00681">HyPerLayer.cpp:681</a></div></div>
<div class="ttc" id="classPV_1_1BaseProbe_html_aad8a3674a2abeafb8c16fb17e28f826a"><div class="ttname"><a href="classPV_1_1BaseProbe.html#aad8a3674a2abeafb8c16fb17e28f826a">PV::BaseProbe::outputStateWrapper</a></div><div class="ttdeci">virtual Response::Status outputStateWrapper(double timef, double dt)</div><div class="ttdef"><b>Definition:</b> <a href="BaseProbe_8cpp_source.html#l00358">BaseProbe.cpp:358</a></div></div>
<div class="ttc" id="classPV_1_1Buffer_html"><div class="ttname"><a href="classPV_1_1Buffer.html">PV::Buffer&lt; float &gt;</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a59b5e16d1b64d30f990e2cc9c06a6cf6"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a59b5e16d1b64d30f990e2cc9c06a6cf6">PV::HyPerLayer::freeExtendedBuffer</a></div><div class="ttdeci">int freeExtendedBuffer(float **buf)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00256">HyPerLayer.cpp:256</a></div></div>
<div class="ttc" id="structPVLayerLoc___html"><div class="ttname"><a href="structPVLayerLoc__.html">PVLayerLoc_</a></div><div class="ttdef"><b>Definition:</b> <a href="PVLayerLoc_8h_source.html#l00021">PVLayerLoc.h:21</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a5aa92946ff7292396576bccb72d60329"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a5aa92946ff7292396576bccb72d60329">PV::HyPerLayer::freeRestrictedBuffer</a></div><div class="ttdeci">int freeRestrictedBuffer(float **buf)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00254">HyPerLayer.cpp:254</a></div></div>
<div class="ttc" id="classPV_1_1Publisher_html_a30fdc583f793a95583d3a06789bebb96"><div class="ttname"><a href="classPV_1_1Publisher.html#a30fdc583f793a95583d3a06789bebb96">PV::Publisher::wait</a></div><div class="ttdeci">int wait(int delay=0)</div><div class="ttdef"><b>Definition:</b> <a href="Publisher_8cpp_source.html#l00166">Publisher.cpp:166</a></div></div>
<div class="ttc" id="classPV_1_1CheckpointableFileStream_html"><div class="ttname"><a href="classPV_1_1CheckpointableFileStream.html">PV::CheckpointableFileStream</a></div><div class="ttdef"><b>Definition:</b> <a href="CheckpointableFileStream_8hpp_source.html#l00013">CheckpointableFileStream.hpp:13</a></div></div>
<div class="ttc" id="classPV_1_1MPIBlock_html"><div class="ttname"><a href="classPV_1_1MPIBlock.html">PV::MPIBlock</a></div><div class="ttdef"><b>Definition:</b> <a href="MPIBlock_8hpp_source.html#l00023">MPIBlock.hpp:23</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_ae4df11ee53d2d7831ec931e5cbb4a6f9"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#ae4df11ee53d2d7831ec931e5cbb4a6f9">PV::HyPerLayer::ioParam_triggerFlag</a></div><div class="ttdeci">virtual void ioParam_triggerFlag(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">triggerFlag: (Deprecated) Specifies if this layer is being triggered </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00724">HyPerLayer.cpp:724</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_ab0088a3129cf584f2df0b50002bb88ac"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#ab0088a3129cf584f2df0b50002bb88ac">PV::HyPerLayer::getDeltaTriggerTime</a></div><div class="ttdeci">virtual double getDeltaTriggerTime()</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01686">HyPerLayer.cpp:1686</a></div></div>
<div class="ttc" id="classPV_1_1Publisher_html"><div class="ttname"><a href="classPV_1_1Publisher.html">PV::Publisher</a></div><div class="ttdef"><b>Definition:</b> <a href="Publisher_8hpp_source.html#l00021">Publisher.hpp:21</a></div></div>
<div class="ttc" id="classPV_1_1BaseObject_html_a2b24e49874218ac1b84418df1d9410ad"><div class="ttname"><a href="classPV_1_1BaseObject.html#a2b24e49874218ac1b84418df1d9410ad">PV::BaseObject::writeParams</a></div><div class="ttdeci">void writeParams()</div><div class="ttdef"><b>Definition:</b> <a href="BaseObject_8hpp_source.html#l00069">BaseObject.hpp:69</a></div></div>
<div class="ttc" id="classPV_1_1Publisher_html_ab17ca30ec01a0d71b7775430b6ab7299"><div class="ttname"><a href="classPV_1_1Publisher.html#ab17ca30ec01a0d71b7775430b6ab7299">PV::Publisher::publish</a></div><div class="ttdeci">int publish(double lastUpdateTime)</div><div class="ttdef"><b>Definition:</b> <a href="Publisher_8cpp_source.html#l00077">Publisher.cpp:77</a></div></div>
<div class="ttc" id="classPV_1_1Timer_html"><div class="ttname"><a href="classPV_1_1Timer.html">PV::Timer</a></div><div class="ttdef"><b>Definition:</b> <a href="Timer_8hpp_source.html#l00026">Timer.hpp:26</a></div></div>
<div class="ttc" id="classPV_1_1Publisher_html_a7112570f86ba629846478f70baa75738"><div class="ttname"><a href="classPV_1_1Publisher.html#a7112570f86ba629846478f70baa75738">PV::Publisher::copyForward</a></div><div class="ttdeci">void copyForward(double lastUpdateTime)</div><div class="ttdef"><b>Definition:</b> <a href="Publisher_8cpp_source.html#l00101">Publisher.cpp:101</a></div></div>
<div class="ttc" id="classPV_1_1Checkpointer_html"><div class="ttname"><a href="classPV_1_1Checkpointer.html">PV::Checkpointer</a></div><div class="ttdef"><b>Definition:</b> <a href="Checkpointer_8hpp_source.html#l00025">Checkpointer.hpp:25</a></div></div>
<div class="ttc" id="classPV_1_1SparseList_html"><div class="ttname"><a href="classPV_1_1SparseList.html">PV::SparseList</a></div><div class="ttdef"><b>Definition:</b> <a href="SparseList_8hpp_source.html#l00014">SparseList.hpp:14</a></div></div>
<div class="ttc" id="classPV_1_1BaseObject_html_aa231f0cd917d5d96d4c94e7d676621f3"><div class="ttname"><a href="classPV_1_1BaseObject.html#aa231f0cd917d5d96d4c94e7d676621f3">PV::BaseObject::readParams</a></div><div class="ttdeci">void readParams()</div><div class="ttdef"><b>Definition:</b> <a href="BaseObject_8hpp_source.html#l00062">BaseObject.hpp:62</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a09e35d33646f5a6dc1e0a81e75de1839"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a09e35d33646f5a6dc1e0a81e75de1839">PV::HyPerLayer::getLayerData</a></div><div class="ttdeci">const float * getLayerData(int delay=0)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01573">HyPerLayer.cpp:1573</a></div></div>
<div class="ttc" id="namespacePV_html"><div class="ttname"><a href="namespacePV.html">PV</a></div><div class="ttdef"><b>Definition:</b> <a href="CheckpointableFileStream_8cpp_source.html#l00003">CheckpointableFileStream.cpp:3</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_abca1bdde7c71b4ffa71aa30f5d0eba88"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#abca1bdde7c71b4ffa71aa30f5d0eba88">PV::HyPerLayer::ioParam_writeSparseValues</a></div><div class="ttdeci">virtual void ioParam_writeSparseValues(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">writeSparseValues: No longer used. </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00862">HyPerLayer.cpp:862</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a4604e955c54550237b44c4d4290655aa"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a4604e955c54550237b44c4d4290655aa">PV::HyPerLayer::ioParam_updateGpu</a></div><div class="ttdeci">virtual void ioParam_updateGpu(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">updateGpu: When compiled using CUDA or OpenCL GPU acceleration, this flag tells whether this layer&amp;#39;s ...</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00621">HyPerLayer.cpp:621</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a820c2695371eced2233ffd17d65bcd98"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a820c2695371eced2233ffd17d65bcd98">PV::HyPerLayer::ioParam_nxScale</a></div><div class="ttdeci">virtual void ioParam_nxScale(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">nxScale: Defines the relationship between the x column size and the layer size. </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00639">HyPerLayer.cpp:639</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a07cb415a70aedf6cc8fc57e493d17139"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a07cb415a70aedf6cc8fc57e493d17139">PV::HyPerLayer::needReset</a></div><div class="ttdeci">virtual bool needReset(double timed, double dt)</div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l01718">HyPerLayer.cpp:1718</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_ad92d8a1d8ed7f9587ee6ef754d455366"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#ad92d8a1d8ed7f9587ee6ef754d455366">PV::HyPerLayer::ioParam_nyScale</a></div><div class="ttdeci">virtual void ioParam_nyScale(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">nyScale: Defines the relationship between the y column size and the layer size. </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00643">HyPerLayer.cpp:643</a></div></div>
<div class="ttc" id="classPV_1_1HyPerLayer_html_a65fe374a6f26682e54bf1c132080ea1d"><div class="ttname"><a href="classPV_1_1HyPerLayer.html#a65fe374a6f26682e54bf1c132080ea1d">PV::HyPerLayer::ioParam_initialWriteTime</a></div><div class="ttdeci">virtual void ioParam_initialWriteTime(enum ParamsIOFlag ioFlag)</div><div class="ttdoc">initialWriteTime: Specifies the first timestep to start outputing pvp files </div><div class="ttdef"><b>Definition:</b> <a href="HyPerLayer_8cpp_source.html#l00830">HyPerLayer.cpp:830</a></div></div>
<div class="ttc" id="structPV_1_1BufferUtils_1_1ActivityHeader_html"><div class="ttname"><a href="structPV_1_1BufferUtils_1_1ActivityHeader.html">PV::BufferUtils::ActivityHeader</a></div><div class="ttdef"><b>Definition:</b> <a href="BufferUtilsPvp_8hpp_source.html#l00040">BufferUtilsPvp.hpp:40</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_661d761cf52f45dc0ac6ea1d43985b5f.html">OpenPV</a></li><li class="navelem"><a class="el" href="dir_a5a2402a07c448d7bb6699a067163b2e.html">src</a></li><li class="navelem"><a class="el" href="dir_9a91aecaef209e538db0ab8c7c763d88.html">layers</a></li><li class="navelem"><b>HyPerLayer.cpp</b></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
